# ランダムMIDI音楽生成アプリケーション - 機能仕様書

## 1. コア機能

### 1.1 ランダムMIDI生成機能
**エンドポイント**: `POST /generate_music`

**機能説明**:
- 指定されたスケール（メジャー/マイナー）と基準音に基づいてランダムなMIDIファイルを生成
- 10〜30個の音符をランダムに生成
- スケール内の音程を確率的に選択、スケール外の音程を低確率で選択
- 音符のベロシティは40〜100の範囲でランダム
- 音符の長さは120（4分音符）、240（2分音符）、480（全音符）からランダム選択

**入力パラメータ**:
- `scale` (string): "major" または "minor"（デフォルト: "major"）
- `base_note` (string): 基準音名（C, C#, D, D#, E, F, F#, G, G#, A, A#, B）（デフォルト: "C"）

**処理フロー**:
1. リクエストパラメータの取得と検証
2. 基準音をMIDIノート番号に変換（C=60）
3. `generate_random_midi()`関数でMIDIファイル生成
4. `generate_mp3()`関数でMP3ファイル生成（非同期）
5. `parse_midi()`関数で楽譜データを抽出
6. セッションにファイルパスを保存
7. JSONレスポンスを返却

**レスポンス形式**:
```json
{
  "wav_file": "mp3_file",
  "midi_file": "/download/midi",
  "notes": ["C/4,q", "D/4,h", ...]
}
```

**エラーハンドリング（優先順位順）**:
1. MIDI生成失敗時: HTTP 500, `{'error': 'Failed to generate MIDI file'}`
2. MP3生成失敗時: HTTP 500, `{'error': 'Failed to generate MP3 file'}`
3. MIDI解析失敗時（notetoname/noteduration未定義値等）: HTTP 500, `{'error': 'Failed to generate score'}`

### 1.2 MIDIファイル生成関数 (`generate_random_midi`)
**関数シグネチャ**:
```python
def generate_random_midi(scale, base_note, filename_prefix)
```

**処理内容**:
1. タイムスタンプとランダム文字列を含む一意のファイル名を生成
2. 新しいMIDIファイルとトラックを作成
3. ピアノの音色（program=0）を設定
4. スケール定義:
   - メジャー: [0, 2, 4, 5, 7, 9, 11]（Cメジャースケールの相対音程）
   - マイナー: [0, 2, 3, 5, 7, 8, 10]（Cマイナースケールの相対音程）
5. 各音符について:
   - 確率分布に基づいて音程を選択
   - MIDIノート番号を24〜108の範囲に制限
   - note_on/note_offメッセージを追加
6. MIDIファイルを保存

**ファイル名形式**: `{prefix}_{YYYYMMDD_HHMMSS}_{6文字ランダム文字列}.mid`

### 1.3 MP3変換機能 (`generate_mp3`)
**関数シグネチャ**:
```python
async def generate_mp3(midi_file, mp3_file_prefix)
```

**処理内容**:
1. タイムスタンプとランダム文字列を含む一意のファイル名を生成
2. Timidity++を使用してMIDIをWAVに変換
   - コマンド: `timidity {midi_file} -Ow -s 44100 -d 16 -o {wav_file}`
   - サンプリングレート: 44100Hz
   - ビット深度: 16bit
   - 出力形式: WAV
3. pydubを使用してWAVをMP3に変換
   - エンコーダ: ffmpeg/lame (pydubが自動選択)
4. 一時WAVファイルを削除
5. MP3ファイルパスを返却

**エラーハンドリング**:
- Timidity実行エラー（return code != 0）: ログ出力後、Noneを返却
- pydub変換エラー: ログ出力後、Noneを返却
- ファイル未検出エラー（FileNotFoundError）: ログ出力後、Noneを返却
- 予期しない例外: ログ出力後、Noneを返却

**非同期処理仕様**:
- この関数は`async`で定義されており、`await generate_mp3()`で呼び出す
- CPU集約的な音声変換処理を非ブロッキングで実行可能（実装では現在同期処理の制限あり）

### 1.4 MIDI解析機能 (`parse_midi`)
**関数シグネチャ**:
```python
def parse_midi(midi_file)
```

**処理内容**:
1. midoライブラリでMIDIファイルを読み込み
2. note_offメッセージから音符情報を抽出
3. `notetoname(note)`: MIDIノート番号→音名変換（match文で0-11をマッピング）
4. `noteduration(duration)`: タイム値→長さ記号変換（120→"q", 240→"h", 480→"w"）
5. 配列形式で返却

**返却形式**: `["C/4,q", "D/4,h", "E/4,w", ...]`
- 形式: `{音名}/{オクターブ},{長さ}`
- 長さ: "q"（4分音符）、"h"（2分音符）、"w"（全音符）

**エラーハンドリング**:
- 不正なMIDIファイル: ログ出力後、Noneを返却
- notetoname()でmatch文に存在しないノート値: MatchError発生（0-11外の値はこれに該当）
  - **要実装**: オクターブ計算後のモジュロ演算により0-11に正規化し、MatchErrorを防止
- noteduration()で想定外の値: MatchError発生
  - **要実装**: デフォルト値（"q"）を返却し、予期しない長さを許容

### 1.5 楽譜表示機能
**技術**: ABCJSライブラリ

**処理内容**:
1. MIDI解析結果をABC記譜法の文字列に変換
2. ABCJSで楽譜をレンダリング
3. ブラウザ上に表示

**変換ロジック** (`convertToABC`):
- 音名マッピング: C# → ^C, D# → ^D, etc.
- オクターブ変換: オクターブ4を基準に、高い音は小文字、低い音はカンマで表現
- 長さ変換: q → 1/4, h → 1/2, w → 1

### 1.6 音声再生機能
**技術**: Web Audio API

**処理内容**:
1. `/random.mp3`エンドポイントからMP3ファイルを取得
2. AudioContextでデコード
3. BufferSourceを作成して再生
4. 再生中の音源を管理し、新しい再生時に前の音源を停止

**エンドポイント**: `GET /random.mp3`
- セッションからMP3ファイルパスを取得
- ファイルを送信（mimetype: audio/mpeg）
- エラー時: HTTP 404/500

### 1.7 MIDIダウンロード機能
**エンドポイント**: `GET /download/midi`

**処理内容**:
1. セッションからMIDIファイルパスを取得
2. `send_from_directory`でファイルを送信
3. ダウンロードファイル名: `music.mid`

**エラーハンドリング**:
- セッションにMIDIファイルがない場合: HTTP 404

### 1.8 セッションクリア機能
**エンドポイント**: `POST /clear_session`

**処理内容**:
1. セッション内のMIDI/MP3ファイルパスを取得
2. ファイルシステムからファイルを削除
3. セッションからファイルパスを削除
4. 成功メッセージを返却

## 2. ユーザーインターフェース

### 2.1 画面構成
- **タイトル**: 「ランダム 音楽生成ツール」
- **説明文**: 日本語と英語の説明
- **コントロールボタン**:
  - Generate Music（音楽生成）
  - Download MIDI（MIDIダウンロード）
  - Play Music（音楽再生）
- **オプション選択**:
  - Scale（スケール）: Major/Minor
  - Base Note（基準音）: C, C#, D, D#, E, F, F#, G, G#, A, A#, B
- **楽譜表示エリア**: ABCJSでレンダリングされた楽譜
- **アフィリエイトリンク**: Amazon商品へのリンク（5件）

### 2.2 UI/UX仕様
- **テーマ**: ダークモード（背景色: #121212、文字色: #fff）
- **ボタンスタイル**: 緑色（#4CAF50）、角丸、ホバー効果
- **無効状態**: グレーアウト（#808080）、カーソル: not-allowed
- **レスポンシブ**: 最大幅800px、中央揃え

## 3. データ構造

### 3.1 MIDI生成パラメータ

#### 3.1.1 スケール定義
**メジャースケール**:
```python
scale_notes = [0, 2, 4, 5, 7, 9, 11]  # Cメジャーの相対音程
```

**マイナースケール**:
```python
scale_notes = [0, 2, 3, 5, 7, 8, 10]  # Cマイナーの相対音程
```

#### 3.1.2 音符選択確率
- スケール内の音程: 実装では`len(scale_notes)`で正規化された確率で均等に選択
  - メジャー: (0.95 / 7) ≈ 13.6%/音符
  - マイナー: (0.95 / 7) ≈ 13.6%/音符
- スケール外の音程: (0.05 / 5)～(0.05 / 6) ≈ 0.8～1%/音符で均等に選択

**注意**: 設計書作成時の95%/5%は、実装では各スケール内音の均等分布のためこの値で正規化される

#### 3.1.3 音符パラメータ
- **音符数**: 10〜30個（ランダム）
- **ベロシティ**: 40〜100（ランダム）
- **長さ**: 120（4分音符）、240（2分音符）、480（全音符）から選択
- **MIDIノート範囲**: 24〜108

### 3.2 音名マッピング

#### 3.2.1 MIDIノート番号 → 音名
```python
note_map = {
    "C": 60, "C#": 61, "D": 62, "D#": 63, "E": 64, "F": 65,
    "F#": 66, "G": 67, "G#": 68, "A": 69, "A#": 70, "B": 71
}
```

#### 3.2.2 音名 → ABC記譜法
```javascript
noteMap = {
    "A": "A", "A#": "^A", "B": "B",
    "C": "C", "C#": "^C", "D": "D",
    "D#": "^D", "E": "E", "F": "F",
    "F#": "^F", "G": "G", "G#": "^G"
}
```

### 3.3 ファイル形式

#### 3.3.1 MIDIファイル
- **形式**: Standard MIDI File (SMF)
- **トラック数**: 1トラック
- **音色**: ピアノ（program=0）
- **タイムベース**: デフォルト（midoのデフォルト値）

#### 3.3.2 MP3ファイル
- **形式**: MPEG-1 Audio Layer 3
- **サンプリングレート**: 44100Hz
- **ビット深度**: 16bit（WAV変換時）
- **エンコーダ**: pydub（FFmpeg/lame使用）
