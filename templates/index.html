<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="G9i_EpglVqPJLEHvjRVmmqChTr3RXQbzz0_vVuroyxg" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Music Composition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #f5f5f7;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            text-align: center;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
            background: linear-gradient(120deg, #fff 0%, #b0b0b5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            font-size: 1.2rem;
            font-weight: 400;
            color: #a1a1a6;
            margin-bottom: 60px;
            line-height: 1.6;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-bottom: 60px;
        }

        .options-group {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        select {
            padding: 12px 16px;
            font-size: 1rem;
            border-radius: 12px;
            background-color: rgba(255, 255, 255, 0.08);
            color: #f5f5f7;
            border: 1px solid rgba(255, 255, 255, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 160px;
        }

        select:hover {
            background-color: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
        }

        select:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .buttons-group {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button, .download-btn {
            padding: 14px 32px;
            font-size: 1.05rem;
            font-weight: 500;
            border: none;
            border-radius: 980px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            letter-spacing: 0.01em;
            min-width: 160px;
        }

        #generateButton {
            background: linear-gradient(135deg, #0071e3 0%, #0051ba 100%);
            color: #fff;
            box-shadow: 0 4px 20px rgba(0, 113, 227, 0.3);
        }

        #generateButton:hover:not(:disabled) {
            background: linear-gradient(135deg, #0077ed 0%, #0052c3 100%);
            box-shadow: 0 8px 30px rgba(0, 113, 227, 0.4);
            transform: translateY(-2px);
        }

        #generateButton:active:not(:disabled) {
            transform: translateY(0);
        }

        #playButton {
            background: linear-gradient(135deg, #34c759 0%, #1fa347 100%);
            color: #fff;
            box-shadow: 0 4px 20px rgba(52, 199, 89, 0.3);
        }

        #playButton:hover:not(:disabled) {
            background: linear-gradient(135deg, #3dd865 0%, #219653 100%);
            box-shadow: 0 8px 30px rgba(52, 199, 89, 0.4);
            transform: translateY(-2px);
        }

        #playButton:active:not(:disabled) {
            transform: translateY(0);
        }

        .download-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #f5f5f7;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .download-btn:hover:not(.disabled) {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .download-btn.disabled,
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        #score {
            width: 100%;
            max-width: 900px;
            height: auto;
            margin: 20px auto 40px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            overflow-x: auto;
            overflow-y: visible;
        }

        #score svg {
            width: 100% !important;
            height: auto !important;
            display: block;
            margin: 0 auto;
        }

        .footer-text {
            margin-top: 80px;
            color: #a1a1a6;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .footer-text a {
            color: #0071e3;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-text a:hover {
            color: #0077ed;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            h1 {
                font-size: 2.5rem;
            }

            h2 {
                font-size: 1rem;
            }

            .options-group,
            .buttons-group {
                flex-direction: column;
            }

            select,
            button,
            .download-btn {
                width: 100%;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            animation: fadeIn 0.6s ease-out;
        }

        .ads-section {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 40px;
            padding: 0 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        .ad-card {
            width: 100%;
            max-width: 120px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            opacity: 0.7;
            display: flex;
            flex-direction: column;
        }

        .ad-card:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .ad-card a {
            text-decoration: none;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .ad-image {
            width: 100%;
            height: 80px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.02);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ad-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ad-info {
            padding: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .ad-price {
            font-size: 0.7rem;
            color: #a1a1a6;
            text-align: right;
            margin-bottom: 4px;
        }

        .ad-title {
            font-size: 0.65rem;
            color: #f5f5f7;
            line-height: 1.2;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .ad-button {
            width: 100%;
            padding: 4px 6px;
            font-size: 0.65rem;
            background-color: #fdaf17;
            color: #000;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .ad-button:hover {
            background-color: #f0a80d;
            transform: scale(1.02);
        }

        @media (max-width: 768px) {
            .ads-section {
                gap: 8px;
            }

            .ad-card {
                max-width: 100px;
            }

            .ad-image {
                height: 70px;
            }

            .ad-title {
                font-size: 0.6rem;
            }

            .ad-price {
                font-size: 0.65rem;
            }

            .ad-button {
                font-size: 0.6rem;
                padding: 3px 4px;
            }
        }
    </style>

</head>
<body>
    <div class="container">
        <h1>Random Music</h1>
        <h2>Ëá™ÂãïÁîüÊàê„Åï„Çå„ÇãÈü≥Ê•Ω<br>Automatically generated music</h2>

        <div class="controls">
            <div class="options-group">
                <select id="scaleSelect">
                    <option value="major">Major Scale</option>
                    <option value="minor">Minor Scale</option>
                </select>
                <select id="baseNoteSelect">
                    <option value="48">C3</option>
                    <option value="60" selected>C4</option>
                    <option value="72">C5</option>
                </select>
            </div>

            <div class="buttons-group">
                <button id="generateButton">Generate Music</button>
                <button id="playButton" class="disabled">Play Music</button>
                <a id="downloadLink" href="#" download="music.mid" class="download-btn disabled">Download MIDI</a>
            </div>
        </div>

        <div id="score"></div>

        <div class="footer-text">
            <p>üéµ Click "Generate Music" to create a new composition<br>
            üîä Click "Play Music" to hear your creation<br>
            üíæ Download as MIDI to use in your DAW</p>
        </div>
    </div>

    <div class="ads-section">
        <div class="ad-card">
            <a rel="noreferrer noopener nofollow" href="https://amzn.to/4ltqojO" target="_blank">
                <div class="ad-image">
                    <img src="https://m.media-amazon.com/images/I/71g8FubyCHL._AC_SX679_.jpg" alt="Akai Professional MIDI" />
                </div>
                <div class="ad-info">
                    <div class="ad-title">Akai Professional MIDI„Ç≠„Éº„Éú„Éº„Éâ</div>
                    <button class="ad-button">Amazon</button>
                </div>
            </a>
        </div>
        <div class="ad-card">
            <a rel="noreferrer noopener nofollow" href="https://amzn.to/3Ysz53M" target="_blank">
                <div class="ad-image">
                    <img src="https://m.media-amazon.com/images/I/710YN7AfcuL._AC_SX679_.jpg" alt="Akai Professional MPC" />
                </div>
                <div class="ad-info">
                    <div class="ad-title">Akai Professional MPC Studio</div>
                    <button class="ad-button">Amazon</button>
                </div>
            </a>
        </div>
        <div class="ad-card">
            <a rel="noreferrer noopener nofollow" href="https://amzn.to/4cx31lt" target="_blank">
                <div class="ad-image">
                    <img src="https://m.media-amazon.com/images/I/71MgYO+IAYL._AC_SX679_.jpg" alt="Audio Technica Headphones" />
                </div>
                <div class="ad-info">
                    <div class="ad-title">„Ç™„Éº„Éá„Ç£„Ç™„ÉÜ„ÇØ„Éã„Ç´ „Éò„ÉÉ„Éâ„Éõ„É≥</div>
                    <button class="ad-button">Amazon</button>
                </div>
            </a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/abcjs/6.0.0/abcjs-basic-min.js?v=1"></script>
    <script src="https://cdn.jsdelivr.net/npm/midi-parser-js@3.0.2/src/midi-parser.min.js?v=1"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsmiddle@1.4.12/jsmiddle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const generateButton = document.getElementById('generateButton');
            const downloadLink = document.getElementById('downloadLink');
            const playButton = document.getElementById('playButton');
            const scoreDiv = document.getElementById('score');
            let currentSynth = null;
            let midiData = null;

            displayEmptyScore();

            generateButton.addEventListener('click', async () => {

                const response = await fetch('/generate_music', {
                    method: 'POST',
                    body: new URLSearchParams({
                        scale: document.getElementById('scaleSelect').value,
                        base_note: document.getElementById('baseNoteSelect').value
                    }),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });

                if (!response.ok) {
                    alert("Server error: " + response.status);
                    return;
                }

                const data = await response.json();
                if (data.notes) {
                    console.log("call displayscore")
                    displayScore(data.notes);
                }
                if (data.midi_file) {
                    downloadLink.href = data.midi_file;
                    downloadLink.classList.remove("disabled");
                    downloadLink.classList.remove("grayed-out");
                }
                if (data.wav_file === 'mp3_file') {
                    playButton.classList.remove("disabled");
                    playButton.classList.remove("grayed-out");
                    console.log("Calling loadMidiFile()");
                    await loadMidiFile();
                    console.log("loadMidiFile() completed");
                }
            });

            playButton.addEventListener('click', async () => {
                console.log("playbutton push")
                await playMidiWithTone();
            });

            async function loadMidiFile() {
                try {
                    const timestamp = new Date().getTime();
                    const url = `/random.mp3?${timestamp}`;
                    console.log("Loading MIDI file from:", url);
                    const response = await fetch(url);
                    
                    console.log("Response status:", response.status);
                    console.log("Response headers:", {
                        'content-type': response.headers.get('content-type'),
                        'content-length': response.headers.get('content-length')
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP status ${response.status}`);
                    }

                    midiData = await response.arrayBuffer();
                    console.log("MIDI file loaded successfully");
                    console.log("File size:", midiData.byteLength, "bytes");
                    console.log("First 20 bytes:", new Uint8Array(midiData).slice(0, 20));
                } catch (error) {
                    console.error("Error loading MIDI file:", error);
                    alert("MIDI„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message);
                }
            }

            async function playMidiWithTone() {
                try {
                    console.log("Playing MIDI...");
                    
                    if (!midiData) {
                        alert("MIDI„Éï„Ç°„Ç§„É´„Åå„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
                        return;
                    }

                    // „Ç™„Éº„Éá„Ç£„Ç™„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÊñ∞Ë¶è‰ΩúÊàê
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("AudioContext created, state:", audioContext.state);
                    
                    // suspended „ÅÆÂ†¥Âêà„ÅØ resume
                    if (audioContext.state === 'suspended') {
                        try {
                            await audioContext.resume();
                            console.log("AudioContext resumed successfully");
                        } catch (err) {
                            console.error("Failed to resume AudioContext:", err);
                        }
                    }

                    console.log("AudioContext state before playback:", audioContext.state);

                    // MIDI „Éë„Éº„Çµ„Éº„Åß„Éá„Éº„Çø„Çí„Éë„Éº„Çπ
                    console.log("Parsing MIDI...");
                    
                    // Ë§áÊï∞„ÅÆ„Éë„Éº„Çµ„Éº„ÇíË©¶„Åô
                    let parsedMidi = null;
                    let notes_events = [];
                    
                    // ÊñπÊ≥ï1: MidiParser „ÇíË©¶„Åô
                    try {
                        parsedMidi = MidiParser.parse(new Uint8Array(midiData));
                        console.log("Method 1 (MidiParser) successful");
                    } catch (err) {
                        console.warn("MidiParser failed:", err);
                    }
                    
                    // ÊñπÊ≥ï2: Á∞°Êòì MIDI „Éë„Éº„Çµ„ÉºÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                    if (!parsedMidi || !parsedMidi.track || parsedMidi.track.length === 0) {
                        console.log("Using fallback MIDI parser...");
                        notes_events = parseMidiManually(new Uint8Array(midiData));
                    } else {
                        const ticksPerBeat = parsedMidi.header && parsedMidi.header.ticksPerBeat 
                            ? parsedMidi.header.ticksPerBeat 
                            : 480;

                        console.log("MIDI parsed successfully, tracks:", parsedMidi.track.length);
                        console.log("parsedMidi.track:", parsedMidi.track);
                        
                        // ÊúÄÂàù„ÅÆ„Éà„É©„ÉÉ„ÇØ„Çí„ÉÄ„É≥„Éó
                        if (parsedMidi.track.length > 0) {
                            const firstTrack = parsedMidi.track[0];
                            console.log("First track:", firstTrack);
                            console.log("First track keys:", Object.keys(firstTrack));
                            
                            if (firstTrack.event) {
                                console.log(`First track has ${firstTrack.event.length} events`);
                                for (let i = 0; i < Math.min(10, firstTrack.event.length); i++) {
                                    console.log(`  Event[${i}]:`, firstTrack.event[i]);
                                }
                            }
                        }
                        
                        // MidiParser „ÅÆÁµêÊûú„Çí„Éé„Éº„Éà„Ç§„Éô„É≥„Éà„Å´Â§âÊèõ
                        for (let trackIdx = 0; trackIdx < parsedMidi.track.length; trackIdx++) {
                            const track = parsedMidi.track[trackIdx];
                            let currentTime = 0;
                            
                            if (!track.event) {
                                console.warn(`Track ${trackIdx} has no event property`);
                                continue;
                            }
                            
                            for (let eventIdx = 0; eventIdx < track.event.length; eventIdx++) {
                                const event = track.event[eventIdx];
                                
                                // „Éá„É´„Çø„Çø„Ç§„É†„ÇíÂä†ÁÆó
                                if (event.deltaTime !== undefined) {
                                    currentTime += event.deltaTime / (ticksPerBeat * 2);
                                }

                                // MidiParser „ÅØ type „ÇíÂçÅÈÄ≤Êï∞„ÅßËøî„Åô (9 = Note On, 8 = Note Off)
                                const eventType = event.type;
                                
                                console.log(`Event ${eventIdx}: type=${eventType}, data=${event.data}`);

                                // Note On „Ç§„Éô„É≥„Éà (type === 9)
                                if (eventType === 9) {
                                    const note = event.data[0];
                                    const velocity = event.data[1];
                                    
                                    console.log(`  -> Note On: note=${note}, velocity=${velocity}`);
                                    
                                    if (velocity > 0) {
                                        notes_events.push({
                                            note: note,
                                            time: currentTime,
                                            duration: 0.4
                                        });
                                        console.log(`     Added to notes_events at time ${currentTime}`);
                                    }
                                }
                            }
                        }
                    }
                    
                    if (notes_events.length === 0) {
                        console.warn("No notes found in MIDI!");
                        alert("Ë≠¶Âëä: MIDI „Éï„Ç°„Ç§„É´„Å´„Éé„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
                        return;
                    }
                    
                    // ÂÜçÁîü„Çπ„Ç±„Ç∏„É•„Éº„É´
                    const startTime = audioContext.currentTime + 0.05;
                    let maxEndTime = 0;
                    
                    console.log(`Scheduling ${notes_events.length} notes...`);
                    
                    for (let i = 0; i < notes_events.length; i++) {
                        const noteEvent = notes_events[i];
                        const frequency = midiNoteToFrequency(noteEvent.note);
                        const scheduleTime = startTime + noteEvent.time;
                        const duration = noteEvent.duration || 0.4;
                        
                        console.log(`[${i}] Note ${noteEvent.note} (${frequency}Hz) at ${scheduleTime}s for ${duration}s`);
                        playNote(audioContext, frequency, scheduleTime, duration);
                        
                        maxEndTime = Math.max(maxEndTime, noteEvent.time + duration);
                    }

                    console.log(`MIDI playback scheduled: ${notes_events.length} notes, duration: ${maxEndTime}s, audioContext.state: ${audioContext.state}`);

                } catch (error) {
                    console.error("Error playing MIDI:", error);
                    console.error("Error stack:", error.stack);
                    alert("MIDIÂÜçÁîü„Ç®„É©„Éº: " + error.message);
                }
            }

            function playNote(audioContext, frequency, startTime, duration) {
                try {
                    const now = audioContext.currentTime;
                    const actualStartTime = Math.max(startTime, now + 0.005);
                    const actualDuration = Math.max(duration, 0.05);
                    const endTime = actualStartTime + actualDuration;

                    // „Ç™„Ç∑„É¨„Éº„Çø„Éº‰ΩúÊàê
                    const oscillator = audioContext.createOscillator();
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(frequency, actualStartTime);

                    // „Ç≤„Ç§„É≥‰ΩúÊàêÔºàÈü≥Èáè„Ç®„É≥„Éô„É≠„Éº„ÉóÔºâ
                    const gain = audioContext.createGain();
                    gain.gain.setValueAtTime(0, actualStartTime);
                    gain.gain.linearRampToValueAtTime(0.3, actualStartTime + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.01, endTime);

                    // Êé•Á∂ö
                    oscillator.connect(gain);
                    gain.connect(audioContext.destination);

                    // ÂÜçÁîü
                    try {
                        oscillator.start(actualStartTime);
                        oscillator.stop(endTime);
                        console.log(`Oscillator scheduled: ${frequency}Hz, start: ${actualStartTime}s, duration: ${actualDuration}s`);
                    } catch (startErr) {
                        console.error("Error starting oscillator:", startErr);
                    }
                } catch (error) {
                    console.error("Error in playNote:", error);
                }
            }

            function midiNoteToFrequency(midiNote) {
                return 440 * Math.pow(2, (midiNote - 69) / 12);
            }

            function parseMidiManually(midiBytes) {
                // Á∞°Êòì MIDI „Éë„Éº„Çµ„ÉºÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
                const notes_events = [];
                
                try {
                    let pos = 0;
                    
                    // MIDI „Éï„Ç°„Ç§„É´„Éò„ÉÉ„ÉÄ„ÉÅ„Çß„ÉÉ„ÇØ
                    const header = String.fromCharCode(midiBytes[0], midiBytes[1], midiBytes[2], midiBytes[3]);
                    if (header !== 'MThd') {
                        console.error("Not a valid MIDI file (missing MThd header)");
                        return notes_events;
                    }
                    
                    pos = 14; // „Éò„ÉÉ„ÉÄ„Çµ„Ç§„Ç∫„Çí„Çπ„Ç≠„ÉÉ„Éó
                    
                    // „Éà„É©„ÉÉ„ÇØ„ÉÅ„É£„É≥„ÇØÂá¶ÁêÜ
                    while (pos < midiBytes.length - 4) {
                        const trackHeader = String.fromCharCode(midiBytes[pos], midiBytes[pos+1], midiBytes[pos+2], midiBytes[pos+3]);
                        if (trackHeader !== 'MTrk') {
                            break;
                        }
                        
                        pos += 4;
                        const trackLength = (midiBytes[pos] << 24) | (midiBytes[pos+1] << 16) | (midiBytes[pos+2] << 8) | midiBytes[pos+3];
                        pos += 4;
                        const trackEnd = pos + trackLength;
                        
                        let currentTime = 0;
                        let ticksPerBeat = 480;
                        
                        while (pos < trackEnd && pos < midiBytes.length) {
                            // „Éá„É´„Çø„Çø„Ç§„É†Ë™≠„ÅøËæº„Åø
                            let deltaTime = 0;
                            let byte;
                            do {
                                byte = midiBytes[pos++];
                                deltaTime = (deltaTime << 7) | (byte & 0x7F);
                            } while (byte & 0x80);
                            
                            currentTime += deltaTime;
                            
                            if (pos >= trackEnd || pos >= midiBytes.length) break;
                            
                            const statusByte = midiBytes[pos++];
                            
                            // „Éé„Éº„Éà„Ç™„É≥ (0x90-0x9F)
                            if ((statusByte >= 0x90 && statusByte <= 0x9F)) {
                                const note = midiBytes[pos++];
                                const velocity = midiBytes[pos++];
                                
                                if (velocity > 0) {
                                    notes_events.push({
                                        note: note,
                                        time: currentTime / (ticksPerBeat * 2),
                                        duration: 0.4
                                    });
                                    console.log(`Manual parse - Note On: ${note} at time ${currentTime}`);
                                }
                            }
                            // „Éé„Éº„Éà„Ç™„Éï (0x80-0x8F)
                            else if ((statusByte >= 0x80 && statusByte <= 0x8F)) {
                                pos += 2; // note, velocity
                            }
                            // „Åù„ÅÆ‰ªñ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
                            else if (statusByte === 0xFF) {
                                const metaType = midiBytes[pos++];
                                let length = 0;
                                let byte;
                                do {
                                    byte = midiBytes[pos++];
                                    length = (length << 7) | (byte & 0x7F);
                                } while (byte & 0x80);
                                pos += length;
                            }
                            else if ((statusByte & 0xF0) === 0xB0 || (statusByte & 0xF0) === 0xC0) {
                                // „Åù„ÅÆ‰ªñ„ÅÆ„ÉÅ„É£„É≥„Éç„É´„É°„ÉÉ„Çª„Éº„Ç∏
                                const dataBytes = (statusByte & 0xF0) === 0xC0 || (statusByte & 0xF0) === 0xD0 ? 1 : 2;
                                pos += dataBytes;
                            }
                        }
                    }
                    
                    console.log(`Manual MIDI parser found ${notes_events.length} notes`);
                } catch (err) {
                    console.error("Error in parseMidiManually:", err);
                }
                
                return notes_events;
            }

            function displayEmptyScore() {
                const abcString = `X:1\nM:4/4\nL:1/4\nK:none\n|z4 z4 z4 z4 z4 z4|`;
                ABCJS.renderAbc("score", abcString);
            }

            function displayScore(notes) {
                const abcString = `X:1\nM:4/4\nL:1/4\nK:none\n${convertToABC(notes)}`;
                console.log(abcString)
                ABCJS.renderAbc("score", abcString);
            }
            function convertToABC(notes) {
                const durationMap = { 'q': "1/4", 'h': "1/2", "w": "1" };
                const noteMap = { 
                    "A": "A", "A#": "^A", "Bb": "_B", "B": "B",
                    "C": "C", "C#": "^C", "Db": "_D", "D": "D",
                    "D#": "^D", "Eb": "_E", "E": "E", "F": "F",
                    "F#": "^F", "Gb": "_G", "G": "G", "G#": "^G"
                };

                let abcNotes = notes.map(note => {
                    let [pitch, duration] = note.split(",");
                    let [noteName, octave] = pitch.split("/");
                    let abcNote = noteMap[noteName] || noteName;
                    let abcOctave = parseInt(octave, 10) - 4;
                    let abcDuration = durationMap[duration] || "1/4";

                    if (abcOctave > 0) {
                        abcNote = abcNote.toLowerCase().repeat(abcOctave);
                    } else if (abcOctave < 0) {
                        abcNote = ",".repeat(Math.abs(abcOctave)) + abcNote;
                    }

                    return abcNote + abcDuration;
                });

                return abcNotes.join(" ");
            }
        });
    </script>
</body>
</html>
