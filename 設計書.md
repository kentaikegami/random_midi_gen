# ランダムMIDI音楽生成アプリケーション 設計書

## 1. プロジェクト概要

### 1.1 プロジェクト名
Random MIDI Generator（ランダムMIDI音楽生成ツール）

### 1.2 目的
ユーザーが指定したスケール（メジャー/マイナー）と基準音に基づいて、ランダムなMIDI音楽を自動生成し、楽譜表示・音声再生・ダウンロード機能を提供するWebアプリケーション。

### 1.3 技術スタック
- **バックエンド**: Python 3.10, Flask (async対応)
- **フロントエンド**: HTML5, JavaScript, ABCJS（楽譜表示ライブラリ）
- **MIDI処理**: mido
- **音声変換**: Timidity++, pydub
- **サーバー**: Gunicorn
- **コンテナ**: Docker, Docker Compose
- **セッション管理**: Flask-Session

## 2. システムアーキテクチャ

### 2.1 全体構成
```
[クライアントブラウザ]
    ↓ HTTP/HTTPS
[Flask Webアプリケーション]
    ↓
[セッション管理 (Flask-Session)]
    ↓
[ファイルシステム (static/)]
    ├── MIDIファイル (.mid)
    └── MP3ファイル (.mp3)
```

### 2.2 主要コンポーネント

#### 2.2.1 バックエンド (`app.py`)
- Flaskアプリケーション本体
- MIDI生成エンジン
- MP3変換エンジン
- セッション管理
- ファイル管理

#### 2.2.2 フロントエンド (`templates/index.html`)
- ユーザーインターフェース
- 楽譜表示（ABCJS）
- 音声再生（Web Audio API）
- API通信（Fetch API）

#### 2.2.3 インフラストラクチャ
- Dockerコンテナ化
- Gunicorn WSGIサーバー
- 環境変数による設定管理

## 3. 機能仕様

### 3.1 コア機能

#### 3.1.1 ランダムMIDI生成機能
**エンドポイント**: `POST /generate_music`

**機能説明**:
- 指定されたスケール（メジャー/マイナー）と基準音に基づいてランダムなMIDIファイルを生成
- 10〜30個の音符をランダムに生成
- スケール内の音程を確率的に選択、スケール外の音程を低確率で選択
- 音符のベロシティは40〜100の範囲でランダム
- 音符の長さは120（4分音符）、240（2分音符）、480（全音符）からランダム選択

**入力パラメータ**:
- `scale` (string): "major" または "minor"（デフォルト: "major"）
- `base_note` (string): 基準音名（C, C#, D, D#, E, F, F#, G, G#, A, A#, B）（デフォルト: "C"）

**入力バリデーション**:
- **scale**: 値が "major" または "minor" 以外の場合は HTTP 400 エラー返却
- **base_note**: 値が C, C#, D, D#, E, F, F#, G, G#, A, A#, B 以外の場合は HTTP 400 エラー返却

**処理フロー**:
1. リクエストパラメータの取得と検証
2. 基準音をMIDIノート番号に変換（C=60）
3. `generate_random_midi()`関数でMIDIファイル生成
4. `generate_mp3()`関数でMP3ファイル生成（非同期処理）
5. `parse_midi()`関数で楽譜データを抽出
6. セッションにファイルパスを保存
7. JSONレスポンスを返却

**レスポンス形式**:
```json
{
  "wav_file": "mp3_file",
  "midi_file": "/download/midi",
  "notes": ["C/4,q", "D/4,h", ...]
}
```

**エラーハンドリング（優先順位順）**:
1. パラメータバリデーション失敗時: HTTP 400, `{'error': 'Invalid scale/base note'}`
2. MIDI生成失敗時: HTTP 500, `{'error': 'Failed to generate MIDI file'}`
3. MP3生成失敗時: HTTP 500, `{'error': 'Failed to generate MP3 file'}`
4. MIDI解析失敗時（notetoname/noteduration例外等）: HTTP 500, `{'error': 'Failed to generate score'}`

#### 3.1.2 MIDIファイル生成関数 (`generate_random_midi`)
**関数シグネチャ**:
```python
def generate_random_midi(scale, base_note, filename_prefix)
```

**処理内容**:
1. タイムスタンプとランダム文字列を含む一意のファイル名を生成
2. 新しいMIDIファイルとトラックを作成
3. ピアノの音色（program=0）を設定
4. スケール定義:
   - メジャー: [0, 2, 4, 5, 7, 9, 11]（Cメジャースケールの相対音程）
   - マイナー: [0, 2, 3, 5, 7, 8, 10]（Cマイナースケールの相対音程）
5. 各音符について:
   - 確率分布に基づいて音程を選択
   - MIDIノート番号を24〜108の範囲に制限
   - note_on/note_offメッセージを追加
6. MIDIファイルを保存

**ファイル名形式**: `{prefix}_{YYYYMMDD_HHMMSS}_{6文字ランダム文字列}.mid`

#### 3.1.3 MP3変換機能 (`generate_mp3`, `_generate_mp3_sync`)
**関数シグネチャ**:
```python
async def generate_mp3(midi_file, mp3_file_prefix)
def _generate_mp3_sync(midi_file, mp3_file_prefix)
```

**処理内容**:
1. `generate_mp3()`は非同期ラッパー関数
   - `asyncio.get_event_loop().run_in_executor()`を使用してブロッキング処理を非同期化
2. `_generate_mp3_sync()`が実際の変換処理
   - タイムスタンプとランダム文字列を含む一意のファイル名を生成
   - Timidity++を使用してMIDIをWAVに変換
     - コマンド: `timidity {midi_file} -Ow -s 44100 -d 16 -o {wav_file}`
     - サンプリングレート: 44100Hz
     - ビット深度: 16bit
     - 出力形式: WAV
   - pydubを使用してWAVをMP3に変換
     - エンコーダ: ffmpeg/lame (pydubが自動選択)
   - 一時WAVファイルを削除
   - MP3ファイルパスを返却

**エラーハンドリング**:
- Timidity実行エラー（return code != 0）: ログ出力後、Noneを返却
- pydub変換エラー: ログ出力後、Noneを返却
- ファイル未検出エラー（FileNotFoundError）: ログ出力後、Noneを返却
- 予期しない例外: ログ出力後、Noneを返却

**非同期処理仕様**:
- この関数は`async`で定義されており、`await generate_mp3()`で呼び出す
- CPU集約的な音声変換処理を非ブロッキングで実行（executor経由）
- 複数の音楽生成リクエストを効率的に処理可能

#### 3.1.4 MIDI解析機能 (`parse_midi`)
**関数シグネチャ**:
```python
def parse_midi(midi_file)
```

**処理内容**:
1. midoライブラリでMIDIファイルを読み込み
2. note_offメッセージから音符情報を抽出
3. `notetoname(note)`: MIDIノート番号→音名変換
   - 実装：辞書ルックアップ（モジュロ演算で0-11に正規化済み）
   - MatchErrorなし、未定義値は"C"を返却
4. `noteduration(duration)`: タイム値→長さ記号変換
   - 実装：辞書ルックアップ
   - 120→"q", 240→"h", 480→"w"
   - 未定義値は"q"（デフォルト）を返却
5. 配列形式で返却

**返却形式**: `["C/4,q", "D/4,h", "E/4,w", ...]`
- 形式: `{音名}/{オクターブ},{長さ}`
- 長さ: "q"（4分音符）、"h"（2分音符）、"w"（全音符）

**エラーハンドリング**:
- 不正なMIDIファイル: ログ出力後、Noneを返却
- notetoname()でも未定義値に対して"C"をデフォルト返却（例外なし）
- noteduration()でも未定義値に対して"q"をデフォルト返却（例外なし）

#### 3.1.5 楽譜表示機能
**技術**: ABCJSライブラリ

**処理内容**:
1. MIDI解析結果をABC記譜法の文字列に変換
2. ABCJSで楽譜をレンダリング
3. ブラウザ上に表示

**変換ロジック** (`convertToABC`):
- 音名マッピング: C# → ^C, D# → ^D, etc.
- オクターブ変換: オクターブ4を基準に、高い音は小文字、低い音はカンマで表現
- 長さ変換: q → 1/4, h → 1/2, w → 1

#### 3.1.6 音声再生機能
**技術**: Web Audio API

**処理内容**:
1. `/random.mp3`エンドポイントからMP3ファイルを取得
2. AudioContextでデコード
3. BufferSourceを作成して再生
4. 再生中の音源を管理し、新しい再生時に前の音源を停止

**エンドポイント**: `GET /random.mp3`
- セッションからMP3ファイルパスを取得
- ファイルを送信（mimetype: audio/mpeg）
- エラー時: HTTP 404/500

#### 3.1.7 MIDIダウンロード機能
**エンドポイント**: `GET /download/midi`

**処理内容**:
1. セッションからMIDIファイルパスを取得
2. `send_from_directory`でファイルを送信
3. ダウンロードファイル名: `music.mid`

**エラーハンドリング**:
- セッションにMIDIファイルがない場合: HTTP 404

#### 3.1.8 セッションクリア機能
**エンドポイント**: `POST /clear_session`

**処理内容**:
1. セッション内のMIDI/MP3ファイルパスを取得
2. ファイルシステムからファイルを削除
3. セッションからファイルパスを削除
4. 成功メッセージを返却

### 3.2 ユーザーインターフェース

#### 3.2.1 画面構成
- **タイトル**: 「ランダム 音楽生成ツール」
- **説明文**: 日本語と英語の説明
- **コントロールボタン**:
  - Generate Music（音楽生成）
  - Download MIDI（MIDIダウンロード）
  - Play Music（音楽再生）
- **オプション選択**:
  - Scale（スケール）: Major/Minor
  - Base Note（基準音）: C, C#, D, D#, E, F, F#, G, G#, A, A#, B
- **楽譜表示エリア**: ABCJSでレンダリングされた楽譜
- **アフィリエイトリンク**: Amazon商品へのリンク（5件）

#### 3.2.2 UI/UX仕様
- **テーマ**: ダークモード（背景色: #121212、文字色: #fff）
- **ボタンスタイル**: 緑色（#4CAF50）、角丸、ホバー効果
- **無効状態**: グレーアウト（#808080）、カーソル: not-allowed
- **レスポンシブ**: 最大幅800px、中央揃え

### 3.3 セッション管理

#### 3.3.1 セッション設定
- **タイプ**: ファイルシステムベース（Flask-Session）
- **有効期限**: 1時間
- **保存ディレクトリ**: `flask_session/`（自動作成、サーバー側保存）
- **保存データ**:
  - `midi_file`: MIDIファイルの絶対パス
  - `mp3_file`: MP3ファイルの絶対パス

#### 3.3.2 セッションキー
- 環境変数`SECRET_KEY`から取得、未設定時は`os.urandom(24)`で生成

#### 3.3.3 セッション管理の制限事項
- **複数ブラウザ/タブでの独立性**: 各ブラウザセッションは独立。複数タブで同時に音楽生成した場合、セッション内のファイルパスは最新のものに上書きされる
- **複数インスタンス非対応**: ファイルシステムベースセッションはサーバー内のみで有効。複数インスタンス環境ではRedis等を使用した共有セッションストアが必要
- **ファイル有効期限**: セッション有効期限切れ後、対応するMIDI/MP3ファイルは手動削除が必要（または定期的なクリーンアップスクリプト）

### 3.4 ファイル管理

#### 3.4.1 保存ディレクトリ
- **パス**: `static/`
- **自動作成**: アプリケーション起動時に`os.makedirs`で作成

#### 3.4.2 ファイル命名規則
- **MIDI**: `random_midi_{YYYYMMDD_HHMMSS}_{6文字ランダム}.mid`
- **MP3**: `random_mp3_{YYYYMMDD_HHMMSS}_{6文字ランダム}.mp3`

#### 3.4.3 ファイルクリーンアップ
- 新しい音楽生成時に、セッション内の古いファイルを削除
- セッションクリア時にファイルを削除
- エラー時は`FileNotFoundError`を無視

## 4. API仕様

### 4.1 エンドポイント一覧

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| GET | `/` | トップページ表示 | 不要 |
| POST | `/generate_music` | 音楽生成 | 不要 |
| GET | `/random.mp3` | MP3ファイル取得 | 不要 |
| GET | `/download/midi` | MIDIファイルダウンロード | 不要 |
| POST | `/clear_session` | セッションクリア | 不要 |

### 4.2 リクエスト/レスポンス詳細

#### 4.2.1 POST /generate_music
**リクエスト**:
- Content-Type: `application/x-www-form-urlencoded`
- Body:
  - `scale`: "major" | "minor"
  - `base_note`: "C" | "C#" | "D" | ... | "B"

**レスポンス（成功）**:
- Status: 200 OK
- Content-Type: application/json
- Body:
```json
{
  "wav_file": "mp3_file",
  "midi_file": "/download/midi",
  "notes": ["C/4,q", "D/4,h", ...]
}
```

**レスポンス（エラー）**:
- Status: 500 Internal Server Error
- Content-Type: application/json
- Body:
```json
{
  "error": "エラーメッセージ"
}
```

#### 4.2.2 GET /random.mp3
**リクエスト**:
- クエリパラメータ: タイムスタンプ（キャッシュ回避用）

**レスポンス（成功）**:
- Status: 200 OK
- Content-Type: audio/mpeg
- Body: MP3ファイルのバイナリデータ

**レスポンス（エラー）**:
- Status: 404 Not Found / 500 Internal Server Error
- Content-Type: application/json
- Body:
```json
{
  "error": "MP3 file not found"
}
```

#### 4.2.3 GET /download/midi
**レスポンス（成功）**:
- Status: 200 OK
- Content-Type: audio/midi
- Content-Disposition: attachment; filename="music.mid"
- Body: MIDIファイルのバイナリデータ

**レスポンス（エラー）**:
- Status: 404 Not Found
- Content-Type: application/json
- Body:
```json
{
  "error": "MIDI file not found"
}
```

#### 4.2.4 POST /clear_session
**レスポンス（成功）**:
- Status: 200 OK
- Content-Type: application/json
- Body:
```json
{
  "message": "Session cleared"
}
```

## 5. データ構造

### 5.1 MIDI生成パラメータ

#### 5.1.1 スケール定義
**メジャースケール**:
```python
scale_notes = [0, 2, 4, 5, 7, 9, 11]  # Cメジャーの相対音程
```

**マイナースケール**:
```python
scale_notes = [0, 2, 3, 5, 7, 8, 10]  # Cマイナーの相対音程
```

#### 5.1.2 音符選択確率
- スケール内の音程: 実装では`len(scale_notes)`で正規化された確率で均等に選択
  - メジャー: (0.95 / 7) ≈ 13.6%/音符
  - マイナー: (0.95 / 7) ≈ 13.6%/音符
- スケール外の音程: (0.05 / 5)～(0.05 / 6) ≈ 0.8～1%/音符で均等に選択

**注意**: 設計書作成時の95%/5%は、実装では各スケール内音の均等分布のためこの値で正規化される

#### 5.1.3 音符パラメータ
- **音符数**: 10〜30個（ランダム）
- **ベロシティ**: 40〜100（ランダム）
- **長さ**: 120（4分音符）、240（2分音符）、480（全音符）から選択
- **MIDIノート範囲**: 24〜108

### 5.2 音名マッピング

#### 5.2.1 MIDIノート番号 → 音名
```python
note_map = {
    "C": 60, "C#": 61, "D": 62, "D#": 63, "E": 64, "F": 65,
    "F#": 66, "G": 67, "G#": 68, "A": 69, "A#": 70, "B": 71
}
```

#### 5.2.2 音名 → ABC記譜法
```javascript
noteMap = {
    "A": "A", "A#": "^A", "B": "B",
    "C": "C", "C#": "^C", "D": "D",
    "D#": "^D", "E": "E", "F": "F",
    "F#": "^F", "G": "G", "G#": "^G"
}
```

### 5.3 ファイル形式

#### 5.3.1 MIDIファイル
- **形式**: Standard MIDI File (SMF)
- **トラック数**: 1トラック
- **音色**: ピアノ（program=0）
- **タイムベース**: デフォルト（midoのデフォルト値）

#### 5.3.2 MP3ファイル
- **形式**: MPEG-1 Audio Layer 3
- **サンプリングレート**: 44100Hz
- **ビット深度**: 16bit（WAV変換時）
- **エンコーダ**: pydub（FFmpeg/lame使用）

## 6. セキュリティ仕様

### 6.1 CORS設定
- **開発環境**: すべてのオリジンを許可
- **本番環境**: 環境変数`ALLOWED_ORIGINS`で指定されたオリジンのみ許可
- **設定方法**: カンマ区切りで複数オリジンを指定可能

### 6.2 セッションセキュリティ
- **セッションキー**: 環境変数`SECRET_KEY`から取得（本番環境推奨）
- **セッション有効期限**: 1時間
- **セッションタイプ**: ファイルシステムベース（サーバー側保存）

### 6.3 ファイルセキュリティ
- **ファイル名**: タイムスタンプとランダム文字列で一意性を確保
- **ファイルアクセス**: セッション経由でのみアクセス可能
- **ファイル削除**: セッションクリア時に自動削除

## 7. デプロイメント仕様

### 7.1 Docker構成

#### 7.1.1 Dockerfile
- **ベースイメージ**: `python:3.10-slim-buster`
- **作業ディレクトリ**: `/app`
- **インストールパッケージ**:
  - システム: gcc, libasound2-dev, timidity, libsndfile1, ffmpeg, lame, python3-pydub
  - Python: requirements.txtからインストール

#### 7.1.2 docker-compose.yml
- **サービス名**: web
- **ポートマッピング**: `5001:5001`
- **ビルド**: Dockerfileを使用
- **環境変数**: PORT=5001（コンテナ内ポート）

### 7.2 サーバー設定

#### 7.2.1 Gunicorn設定
- **ワーカー数**: 3
- **タイムアウト**: 120秒
- **バインド**: `0.0.0.0:8000`（Dockerfile内）
- **アプリケーション**: `app:app`

#### 7.2.2 環境変数
| 変数名 | 説明 | 必須 | デフォルト値 |
|--------|------|------|--------|
| `PORT` | アプリケーションのポート番号 | 任意 | 5001 |
| `SECRET_KEY` | セッションキー（本番環境必須） | 本番環境で必須 | `os.urandom(24)` |
| `ALLOWED_ORIGINS` | CORS許可オリジン（カンマ区切り） | 任意 | すべてのオリジンを許可 |

**本番環境での推奨設定**:
```bash
export SECRET_KEY="生成されたランダムキー"
export ALLOWED_ORIGINS="https://example.com,https://www.example.com"
```

### 7.3 依存関係

#### 7.3.1 Pythonパッケージ（requirements.txt）
```
Flask[async]
Flask-Session
mido
Flask-Cors
gunicorn
timidity
pydub
```

#### 7.3.2 システムパッケージ（Aptfile）
```
timidity
```

#### 7.3.3 外部ツール概要
| ツール | 用途 | インストール |
|--------|------|--------|
| **Timidity++** | MIDI → WAV変換 | apt-get install timidity |
| **FFmpeg/lame** | WAV → MP3エンコード（pydubが使用） | apt-get install ffmpeg lame |
| **libsndfile1** | Timidity++の音声処理ライブラリ依存 | apt-get install libsndfile1 |
| **gcc** | C言語コンパイラ（一部Pythonパッケージのビルド用） | apt-get install gcc |
| **libasound2-dev** | ALSA音声ライブラリ（Timidity++の依存） | apt-get install libasound2-dev |

## 8. エラーハンドリング

### 8.1 エラー種別

#### 8.1.1 バリデーションエラー
- **発生箇所**: `generate_music()`エンドポイント
- **エラー種別**:
  - 無効なscale値（"major" / "minor" 以外）
  - 無効なbase_note値（12音階外）
- **処理**: ログ出力、HTTP 400エラー返却
- **上位処理**: ユーザーにバリデーションエラーを通知

#### 8.1.2 MIDI生成エラー
- **発生箇所**: `generate_random_midi()`
- **原因**: メモリ不足、ファイルシステムエラー、権限不足など
- **処理**: ログ出力、Noneを返却
- **上位処理**: HTTP 500エラーを返却

#### 8.1.3 MP3変換エラー
- **発生箇所**: `_generate_mp3_sync()`
- **エラー種別と対応**:
  - Timidity実行エラー（return code != 0）: ログ出力、Noneを返却
  - pydub変換エラー: ログ出力、Noneを返却
  - ファイル未検出エラー（FileNotFoundError）: ログ出力、Noneを返却
  - 予期しない例外: ログ出力、Noneを返却
- **上位処理**: HTTP 500エラーを返却

#### 8.1.4 MIDI解析エラー
- **発生箇所**: `parse_midi()`
- **エラー種別と対応**:
  - MIDI読み込み失敗: ログ出力、Noneを返却
  - notetoname()でも未定義値に対して"C"をデフォルト返却（例外なし）
  - noteduration()でも未定義値に対して"q"をデフォルト返却（例外なし）
- **上位処理**: HTTP 500エラーを返却

#### 8.1.5 ファイルアクセスエラー
- **発生箇所**: `/random.mp3`, `/download/midi`
- **エラー種別と対応**:
  - セッションにファイルパスがない: HTTP 404返却
  - ファイルが存在しない（FileNotFoundError）: HTTP 404返却
  - パストラバーサル試行（is_safe_path()失敗）: HTTP 403返却
  - その他のエラー: HTTP 500返却

### 8.2 ログシステム

#### 8.2.1 ログ設定
```python
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)
```

#### 8.2.2 ログレベル別の用途
| レベル | 用途 | 記録内容 |
|--------|------|--------|
| INFO | 正常なフロー | エンドポイント呼び出し、ファイル生成成功、ファイル削除成功 |
| WARNING | 予期しない入力 | バリデーションエラー、ファイル削除失敗、パストラバーサル試行 |
| ERROR | 処理エラー | MP3変換失敗、MIDI解析エラー、Timidityエラー |
| DEBUG | 詳細情報 | 絶対パス、オブジェクト情報、返り値検証 |

#### 8.2.3 ログ出力例
```python
logger.info("generate_music endpoint called")
logger.warning(f"Invalid scale received: {scale}")
logger.error(f"Timidity error: {stderr}")
logger.debug(f"MP3 file absolute path: {mp3_file}")
```

### 8.3 ファイルセキュリティ機能

#### 8.3.1 パストラバーサル対策
```python
def is_safe_path(filepath):
    """ファイルパスがUPLOAD_FOLDER内にあることを確認"""
    try:
        base = os.path.abspath(UPLOAD_FOLDER)
        target = os.path.abspath(filepath)
        return target.startswith(base) and os.path.isfile(target)
    except (ValueError, OSError):
        return False
```

#### 8.3.2 安全なファイル削除
```python
def safe_remove_file(filepath):
    """安全にファイルを削除"""
    try:
        if is_safe_path(filepath):
            os.remove(filepath)
            logger.info(f"Deleted file: {filepath}")
            return True
        else:
            logger.warning(f"Unsafe path attempted: {filepath}")
            return False
    except PermissionError:
        logger.error(f"Permission denied deleting: {filepath}")
        return False
    except OSError as e:
        logger.error(f"Error deleting {filepath}: {e}")
        return False
```

## 9. パフォーマンス仕様

### 9.1 処理時間（実測値）
| 処理 | 音符数10 | 音符数20 | 音符数30 | 備考 |
|------|---------|---------|---------|------|
| MIDI生成 | <10ms | <10ms | <10ms | CPUバウンド |
| MP3変換 | 3-4秒 | 4-5秒 | 5-6秒 | Timidity+pydub |
| MIDI解析 | <5ms | <5ms | <5ms | CPUバウンド |
| **合計** | **3-4秒** | **4-5秒** | **5-6秒** | サーバー側処理時間 |

### 9.2 リソース使用量
- **メモリ**: 生成ファイルサイズに依存（通常10-50MB）
  - MIDI: 数KB
  - MP3: 数MB（サンプリングレート44100Hz、16bit、平均ビットレート）
- **ディスク**: 生成されたファイルの保存（セッション有効期限1時間内）
  - 同時セッション数が多いとディスク使用量増加の可能性
- **CPU**: MP3変換時に高負荷（マルチコア活用でスケーリング可能）

### 9.3 最適化
- **ファイルクリーンアップ**: 新しい生成時に古いファイルを削除（セッション内）
- **セッション有効期限**: 1時間で自動削除、期限切れセッションの定期クリーンアップが必要
- **非同期処理**: MP3変換を非同期で実行する設計（現在実装では制限あり）
- **スケーリング**: 複数インスタンスを並列実行し、ロードバランサで分散

## 11. テスト仕様

### 11.1 単体テスト
| テスト項目 | テスト対象 | テストケース | 期待結果 |
|-----------|-----------|------------|--------|
| MIDI生成 | `generate_random_midi()` | 正常系：major, minorスケール | ファイル生成成功、戻り値はファイルパス |
| MIDI生成 | `generate_random_midi()` | エッジケース：ノート範囲24-108 | MIDIノート範囲内に正規化される |
| MP3変換 | `generate_mp3()` | 正常系：有効なMIDIファイル | MP3ファイル生成成功、戻り値はファイルパス |
| MP3変換 | `generate_mp3()` | エラー系：不正なMIDIファイル | Noneを返却 |
| MIDI解析 | `parse_midi()` | 正常系：生成されたMIDIファイル | リスト形式の音符データ返却 |
| MIDI解析 | `parse_midi()` | エラー系：不正なMIDIファイル | Noneを返却 |
| 音名変換 | `notetoname()` | 正常系：0-11 | C, C#, D, ... B を返却 |
| 音名変換 | `notetoname()` | エッジケース：モジュロ演算 | note % 12で正規化後、正しい音名返却 |
| 長さ変換 | `noteduration()` | 正常系：120, 240, 480 | q, h, w を返却 |
| 長さ変換 | `noteduration()` | エラー系：その他の値 | デフォルト値（q）を返却 |

### 11.2 統合テスト
| テスト項目 | テストシナリオ | 期待結果 |
|-----------|---------------|--------|
| 音楽生成フロー | POST /generate_music（major, C） | HTTP 200, notes配列、midi_file、wav_file返却 |
| 音楽生成フロー | POST /generate_music（minor, G#） | HTTP 200, notes配列返却 |
| MP3再生 | GET /random.mp3（生成後） | HTTP 200, MP3ファイル返却 |
| MIDIダウンロード | GET /download/midi（生成後） | HTTP 200, MIDIファイル返却、Content-Disposition設定 |
| セッションクリア | POST /clear_session | HTTP 200, メッセージ返却、ファイル削除 |
| セッション有効期限 | セッション1時間経過後 | セッション無効化、ファイル削除 |

### 11.3 エラーケーステスト
| テスト項目 | 条件 | 期待結果 |
|-----------|------|--------|
| 無効なスケール | POST /generate_music?scale=invalid | デフォルト（major）が使用される、または HTTP 400 |
| 無効な基準音 | POST /generate_music?base_note=H | エラーメッセージ、または HTTP 400 |
| セッションなし | GET /random.mp3（セッション未作成） | HTTP 404 |
| ファイル削除後 | GET /random.mp3（ファイル削除済） | HTTP 404 |
| MP3生成失敗 | Timidity++がインストールされていない環境 | HTTP 500, エラーメッセージ返却 |

### 11.4 パフォーマンステスト
| テスト項目 | 測定内容 | 許容値 |
|-----------|---------|--------|
| MIDI生成時間 | 10-30音符のランダム生成 | <50ms |
| MP3変換時間 | MIDI→MP3変換（20音符） | <10秒 |
| ファイルサイズ | MP3ファイル（20音符） | <5MB |
| メモリ使用量 | 同時10セッション | <500MB |
| 応答時間 | /generate_music完全処理 | <15秒 |

## 12. 今後の拡張可能性

### 12.1 機能拡張
- 複数のスケール対応（ペンタトニック、ブルーススケール、ドリアンモード等）
- 複数の音色対応（ピアノ以外の楽器）
- リズムパターンの選択（拍子、テンポの制御）
- 音楽スタイルの選択（ジャズ、クラシック、EDM等の音響特性）
- ユーザーアカウント機能（生成履歴保存）
- 生成履歴の保存・共有機能
- MusicXML形式での楽譜出力
- ブラウザ内リアルタイム楽譜編集機能

### 12.2 技術的改善
- **セッション管理**: Redis等を使用した分散セッション管理（複数インスタンス対応）
- **非同期処理最適化**: asyncio/Celeryを使用したバックグラウンドタスク実装
- **エラーハンドリング強化**: 
  - `notetoname()`と`noteduration()`の例外処理（MatchError対応）
  - より詳細なエラーレスポンス（エラーコード体系）
- **ログシステム導入**: Python loggingライブラリで構造化ログ管理
- **ユニットテスト追加**: pytest等でテストカバレッジ向上
- **CI/CDパイプル構築**: GitHub Actions等による自動テスト・デプロイ
- **キャッシング**: 同じパラメータでの生成結果をキャッシュ
- **データベース導入**: 生成履歴管理、ユーザー管理用

## 13. 付録

### 13.1 ファイル構成
```
random_midi_gen/
├── app.py                 # メインアプリケーション
├── requirements.txt       # Python依存関係
├── Dockerfile            # Dockerイメージ定義
├── docker-compose.yml    # Docker Compose設定
├── Aptfile              # システムパッケージ依存関係
├── LICENSE              # ライセンス情報
├── 設計書.md            # 本ドキュメント（統合版）
├── 設計書_機能仕様.md   # 機能詳細仕様書
├── 設計書_API仕様.md    # API詳細仕様書
├── 設計書_デプロイメント.md  # デプロイメント手順書
├── templates/
│   └── index.html       # フロントエンドHTML
└── static/              # 生成ファイル保存ディレクトリ（自動作成）
    ├── random_midi_YYYYMMDD_HHMMSS_XXXXXX.mid  # 生成MIDI
    └── random_mp3_YYYYMMDD_HHMMSS_XXXXXX.mp3   # 生成MP3
```

### 13.2 主要関数一覧

| 関数名 | 説明 | 入力 | 戻り値 |
|--------|------|------|--------|
| `is_safe_path()` | ファイルパスセキュリティチェック | filepath | bool |
| `safe_remove_file()` | 安全なファイル削除 | filepath | bool |
| `generate_random_midi()` | ランダムMIDIファイル生成 | scale, base_note, prefix | str (path) |
| `generate_mp3()` | MP3変換（非同期） | midi_file, prefix | coroutine → str (path) |
| `_generate_mp3_sync()` | MP3変換（同期実装） | midi_file, prefix | str (path) |
| `parse_midi()` | MIDIファイル解析 | midi_file | list または None |
| `notetoname()` | ノート番号→音名変換 | note (int) | str ("C"-"B") |
| `noteduration()` | タイム値→長さ記号変換 | duration (int) | str ("q"/"h"/"w") |
| `generate_music()` | [エンドポイント] 音楽生成API | form: scale, base_note | JSON response |
| `get_mp3()` | [エンドポイント] MP3取得API | query: timestamp | MP3 binary / JSON |
| `download_midi()` | [エンドポイント] MIDI DL API | なし | MIDI binary / JSON |
| `clear_session()` | [エンドポイント] セッションクリア | なし | JSON response |

---

**作成日**: 2024年
**バージョン**: 1.2
**最終更新**: 2026年1月7日

**変更履歴**:
- v1.0 (2024年): 初版作成
- v1.1 (2026年1月7日): 
  - エラーハンドリング詳細化（notetoname/noteduration のMatchError対応）
  - 確率分布の正規化説明を追加
  - 環境変数（PORT）ドキュメント追加
  - セッション管理の制限事項を明記
  - パフォーマンス指標を定量化
  - テスト仕様セクション追加
  - Timidity++/FFmpeg/lameの役割を明確化
  - 非同期処理仕様を詳細化
- v1.2 (2026年1月7日):
  - **項目2**: MatchError対応 - notetoname()とnoteduration()を辞書ルックアップに変更、デフォルト値返却
  - **項目3**: 入力バリデーション - サーバー側でscale, base_noteをバリデーション追加、HTTP 400返却
  - **項目4**: 非同期処理実装 - asyncio.run_in_executor()で真の非同期化
  - **項目5**: ロギングシステム導入 - loggingモジュール導入、print→logger置き換え
  - **項目6**: パストラバーサル対策 - is_safe_path()関数追加
  - **項目7**: ファイル削除安全化 - safe_remove_file()関数実装、権限チェック・ログ記録
