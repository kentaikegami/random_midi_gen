# ランダムMIDI音楽生成アプリケーション - テスト仕様書

## 1. テスト戦略

### 1.1 テスト体系図
```
テスト
├── ユニットテスト（Unit Test）
│   ├── MIDI生成関数のテスト
│   ├── MP3変換関数のテスト
│   ├── MIDI解析関数のテスト
│   ├── 音名変換関数のテスト
│   └── 長さ変換関数のテスト
├── 統合テスト（Integration Test）
│   ├── エンドポイント統合テスト
│   ├── セッション管理テスト
│   └── ファイル管理テスト
├── API テスト（E2E Test）
│   ├── 正常系テスト
│   ├── エラーハンドリングテスト
│   └── パフォーマンステスト
└── セキュリティテスト
    ├── パストラバーサル対策
    ├── CORS設定
    └── バリデーション
```

### 1.2 テストフレームワーク・ツール
| ツール | 用途 | 備考 |
|--------|------|------|
| **pytest** | ユニットテスト・統合テスト | Python標準テストフレームワーク |
| **pytest-asyncio** | 非同期テスト | async/await対応 |
| **pytest-cov** | カバレッジ測定 | カバレッジ80%以上を目指す |
| **Flask Testing** | APIテスト | Flaskのテストクライアント |
| **unittest.mock** | モック・スタブ | 外部依存をモック化 |

### 1.3 テスト実行環境
- **Python**: 3.10以上
- **OS**: Linux/macOS/Windows
- **依存パッケージ**: requirements-dev.txt に記載

---

## 2. ユニットテスト

### 2.1 MIDI生成関数テスト

**テスト対象**: `generate_random_midi(scale, base_note, filename_prefix)`

#### 2.1.1 正常系テスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-MIDI-001 | メジャースケール生成 | scale="major", base_note="C" | MIDIファイル生成成功、ファイルパス返却 | ファイルが存在し、mido で読込可能 |
| UT-MIDI-002 | マイナースケール生成 | scale="minor", base_note="G" | MIDIファイル生成成功、ファイルパス返却 | ファイルが存在し、mido で読込可能 |
| UT-MIDI-003 | 全ての基準音テスト | scale="major", base_note="A#" | MIDIファイル生成成功 | C, C#, D, D#, E, F, F#, G, G#, A, A#, B すべてで成功 |
| UT-MIDI-004 | ファイル名形式検証 | scale="major", base_note="C" | ファイル名が `{prefix}_{YYYYMMDD_HHMMSS}_{6文字ランダム}.mid` の形式 | タイムスタンプが現在時刻に近い値 |
| UT-MIDI-005 | MIDIノート範囲検証 | scale="major", base_note="C" | すべてのノート値が24〜108の範囲内 | mido で読込み、ノート値を検証 |
| UT-MIDI-006 | ベロシティ範囲検証 | scale="major", base_note="C" | すべてのベロシティ値が40〜100の範囲内 | note_on イベントのvelocity を検証 |
| UT-MIDI-007 | 音符数検証 | scale="major", base_note="C" | 音符数が10〜30の範囲内 | note_off イベント数を数える |
| UT-MIDI-008 | スケール内音程検証 | scale="major", base_note="C" | 生成されたノート値がメジャースケール内 | ノート値 % 12 がスケール定義に含まれるか検証 |
| UT-MIDI-009 | ピアノプログラム検証 | scale="major", base_note="C" | program_change メッセージが0（ピアノ） | mido で read してprogram を検証 |

#### 2.1.2 エッジケーステスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-MIDI-010 | ファイル上書き | 同一ファイル名で複数回呼び出し | ファイル名がランダムになるため、衝突しない | 6文字ランダム文字列の一意性 |
| UT-MIDI-011 | 並行実行 | 複数スレッドで同時に呼び出し | すべてが正常にファイル生成 | スレッドセーフ性を確認 |
| UT-MIDI-012 | メモリ使用量検証 | 大規模MIDIファイル生成（max 30音符） | メモリ使用量が適切な範囲内 | メモリリーク検出用 |

#### 2.1.3 エラーケーステスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-MIDI-013 | 無効なscale値 | scale="jazz" | ValueError 発生 | 呼び出し元で事前バリデーション |
| UT-MIDI-014 | 無効なbase_note値 | base_note="H" | ValueError 発生 | 呼び出し元で事前バリデーション |
| UT-MIDI-015 | ディスク容量不足 | ファイルシステム容量ゼロ | OSError 発生、適切にハンドリング | mock を使用してシミュレート |
| UT-MIDI-016 | 権限不足 | static/ディレクトリの書き込み権限なし | PermissionError 発生 | mock を使用してシミュレート |

**テストコード例**:
```python
import pytest
import os
from mido import MidiFile
from app import generate_random_midi

def test_generate_random_midi_major():
    """メジャースケール生成テスト"""
    midi_file = generate_random_midi("major", "C", "test_midi")
    assert midi_file is not None
    assert os.path.exists(midi_file)
    
    # MIDIファイルを読み込んで検証
    midi = MidiFile(midi_file)
    assert len(midi.tracks) >= 1
    
    # クリーンアップ
    os.remove(midi_file)

def test_generate_random_midi_note_range():
    """ノート範囲検証テスト"""
    midi_file = generate_random_midi("major", "C", "test_midi")
    midi = MidiFile(midi_file)
    
    notes = []
    for msg in midi.tracks[0]:
        if msg.type == 'note_on' and msg.velocity > 0:
            notes.append(msg.note)
    
    assert all(24 <= note <= 108 for note in notes), "ノート範囲外の値が含まれています"
    
    os.remove(midi_file)
```

---

### 2.2 MP3変換関数テスト

**テスト対象**: `generate_mp3(midi_file, mp3_file_prefix)` (async)

#### 2.2.1 正常系テスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-MP3-001 | MP3生成成功 | 有効なMIDIファイル | MP3ファイル生成成功、ファイルパス返却 | ファイルが存在し、44100Hz 16bit |
| UT-MP3-002 | ファイル名形式検証 | MIDIファイル | MP3ファイル名が `{prefix}_{YYYYMMDD_HHMMSS}_{6文字ランダム}.mp3` | タイムスタンプ検証 |
| UT-MP3-003 | 一時ファイル削除 | MIDIファイル | 処理後、WAVファイルが削除されている | WAVファイルが残ってないか確認 |
| UT-MP3-004 | ファイルサイズ検証 | 20音符のMIDIファイル | MP3ファイルサイズが合理的な範囲（<10MB） | ファイルサイズチェック |
| UT-MP3-005 | 非同期実行検証 | MIDIファイル | async/await で正常に実行 | asyncio.run() で実行確認 |

#### 2.2.2 エラーケーステスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-MP3-006 | 不正なMIDIファイル | 存在しないファイルパス | FileNotFoundError 返却 | ログに記録され、None返却 |
| UT-MP3-007 | Timidity エラー | 破損したMIDIファイル | Timidity 実行エラーハンドリング、None返却 | mock subprocess を使用 |
| UT-MP3-008 | FFmpeg エラー | WAV生成は成功、MP3エンコード失敗 | pydub エラーハンドリング、None返却 | mock pydub を使用 |
| UT-MP3-009 | ディスク容量不足 | ファイルシステム容量ゼロ | OSError 返却、適切にハンドリング | mock を使用 |

**テストコード例**:
```python
import pytest
import asyncio
import os
from app import generate_random_midi, generate_mp3

@pytest.mark.asyncio
async def test_generate_mp3_success():
    """MP3生成成功テスト"""
    # MIDI生成
    midi_file = generate_random_midi("major", "C", "test_midi")
    
    # MP3生成
    mp3_file = await generate_mp3(midi_file, "test_mp3")
    
    assert mp3_file is not None
    assert os.path.exists(mp3_file)
    assert mp3_file.endswith('.mp3')
    
    # クリーンアップ
    os.remove(midi_file)
    os.remove(mp3_file)

@pytest.mark.asyncio
async def test_generate_mp3_file_not_found():
    """ファイルなしエラーテスト"""
    mp3_file = await generate_mp3("nonexistent.mid", "test_mp3")
    assert mp3_file is None
```

---

### 2.3 MIDI解析関数テスト

**テスト対象**: `parse_midi(midi_file)`

#### 2.3.1 正常系テスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-PARSE-001 | MIDI解析成功 | 生成されたMIDIファイル | リスト形式の音符データ返却 | `["C/4,q", "D/4,h", ...]` 形式 |
| UT-PARSE-002 | 音符数一致 | 10音符のMIDIファイル | 返却されたリスト長が10 | parse_midi が正しく数える |
| UT-PARSE-003 | 音名正当性 | MIDIファイル | すべての音名がC-Bのいずれか | 音名検証 |
| UT-PARSE-004 | オクターブ正当性 | MIDIファイル（ノート24-108） | オクターブが0-7の範囲 | オクターブ計算式検証 |
| UT-PARSE-005 | 長さ記号正当性 | MIDIファイル | すべての長さが "q", "h", "w" のいずれか | 長さ記号検証 |

#### 2.3.2 エッジケーステスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-PARSE-006 | 最低ノート（24） | ノート24のMIDIファイル | 正しくパース、オクターブ計算正確 | オクターブ0に正規化 |
| UT-PARSE-007 | 最高ノート（108） | ノート108のMIDIファイル | 正しくパース、オクターブ計算正確 | オクターブ8に正規化 |
| UT-PARSE-008 | 黒鍵ノート | C#, D#, F#, G#, A# を含むMIDIファイル | 正しく解析、音名に#を含む | シャープの記号検証 |

#### 2.3.3 エラーケーステスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-PARSE-009 | ファイルなし | 存在しないファイルパス | None返却、ログ記録 | FileNotFoundError ハンドリング |
| UT-PARSE-010 | 破損したMIDIファイル | 不正なMIDIフォーマット | None返却、ログ記録 | mido の例外ハンドリング |

**テストコード例**:
```python
import pytest
from app import generate_random_midi, parse_midi

def test_parse_midi_success():
    """MIDI解析成功テスト"""
    midi_file = generate_random_midi("major", "C", "test_midi")
    notes = parse_midi(midi_file)
    
    assert notes is not None
    assert isinstance(notes, list)
    assert len(notes) > 0
    
    # 各音符が正しい形式か確認
    for note in notes:
        parts = note.split(',')
        assert len(parts) == 2
        assert '/' in parts[0]  # 音名/オクターブ
        assert parts[1] in ['q', 'h', 'w']  # 長さ
    
    os.remove(midi_file)

def test_parse_midi_file_not_found():
    """ファイルなしエラーテスト"""
    notes = parse_midi("nonexistent.mid")
    assert notes is None
```

---

### 2.4 音名変換関数テスト

**テスト対象**: `notetoname(note)`

#### 2.4.1 正常系テスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-NOTE-001 | C（ノート0） | note=0 | "C" 返却 | 0 % 12 = 0 |
| UT-NOTE-002 | C#（ノート1） | note=1 | "C#" 返却 | 1 % 12 = 1 |
| UT-NOTE-003 | B（ノート11） | note=11 | "B" 返却 | 11 % 12 = 11 |
| UT-NOTE-004 | オクターブ超過（C） | note=12 | "C" 返却 | 12 % 12 = 0 → "C" |
| UT-NOTE-005 | 全ノート（0-11） | note=0-11 | 対応する音名返却 | すべての音階をテスト |
| UT-NOTE-006 | 大きなノート値 | note=108 | "C" 返却 | 108 % 12 = 0 |

#### 2.4.2 エラーケーステスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-NOTE-007 | 負の値 | note=-1 | "B" 返却（Python モジュロの挙動） | -1 % 12 = 11 |
| UT-NOTE-008 | None入力 | note=None | TypeError 発生 | 呼び出し元でバリデーション |
| UT-NOTE-009 | 文字列入力 | note="C" | TypeError 発生 | 呼び出し元でバリデーション |

**テストコード例**:
```python
import pytest
from app import notetoname

def test_notetoname_basic():
    """基本的な音名変換テスト"""
    assert notetoname(0) == "C"
    assert notetoname(1) == "C#"
    assert notetoname(12) == "C"
    assert notetoname(108) == "C"

def test_notetoname_all_notes():
    """全ノートテスト"""
    expected = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"]
    for i in range(12):
        assert notetoname(i) == expected[i]
```

---

### 2.5 長さ変換関数テスト

**テスト対象**: `noteduration(duration)`

#### 2.5.1 正常系テスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-DUR-001 | 4分音符 | duration=120 | "q" 返却 | quarter note |
| UT-DUR-002 | 2分音符 | duration=240 | "h" 返却 | half note |
| UT-DUR-003 | 全音符 | duration=480 | "w" 返却 | whole note |

#### 2.5.2 エッジケーステスト

| テストケースID | テスト項目 | 入力 | 期待結果 | 備考 |
|--------|---------|------|--------|------|
| UT-DUR-004 | 想定外の値 | duration=100 | "q" 返却（デフォルト） | デフォルト値を返却 |
| UT-DUR-005 | ゼロ | duration=0 | "q" 返却（デフォルト） | デフォルト値を返却 |
| UT-DUR-006 | 負の値 | duration=-120 | "q" 返却（デフォルト） | デフォルト値を返却 |

**テストコード例**:
```python
import pytest
from app import noteduration

def test_noteduration_valid():
    """有効な長さ値のテスト"""
    assert noteduration(120) == "q"
    assert noteduration(240) == "h"
    assert noteduration(480) == "w"

def test_noteduration_invalid():
    """無効な長さ値のテスト"""
    assert noteduration(100) == "q"  # デフォルト
    assert noteduration(0) == "q"    # デフォルト
    assert noteduration(-120) == "q" # デフォルト
```

---

## 3. 統合テスト

### 3.1 エンドポイント統合テスト

**テスト対象**: Flask エンドポイント

#### 3.1.1 POST /generate_music - 正常系

| テストケースID | テスト項目 | リクエスト | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| IT-GEN-001 | 音楽生成成功（major） | POST /generate_music, scale=major, base_note=C | HTTP 200, JSON レスポンス（notes, wav_file, midi_file） | セッションにファイルパス保存 |
| IT-GEN-002 | 音楽生成成功（minor） | POST /generate_music, scale=minor, base_note=G | HTTP 200, JSON レスポンス | セッション確認 |
| IT-GEN-003 | 全基準音テスト | scale=major, base_note=各12音階 | HTTP 200 | すべての基準音で成功 |
| IT-GEN-004 | notes 配列検証 | POST /generate_music（正常） | レスポンスに notes 配列が含まれる | `["C/4,q", ...]` 形式 |
| IT-GEN-005 | midi_file パス検証 | POST /generate_music（正常） | レスポンスに midi_file="/download/midi" | ダウンロードエンドポイント参照 |
| IT-GEN-006 | wav_file 値検証 | POST /generate_music（正常） | レスポンスに wav_file="mp3_file" | MP3ファイル生成確認 |

#### 3.1.2 POST /generate_music - エラー系

| テストケースID | テスト項目 | リクエスト | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| IT-GEN-007 | 無効なscale | scale=jazz | HTTP 400, エラーメッセージ | バリデーションエラー |
| IT-GEN-008 | 無効なbase_note | base_note=H | HTTP 400, エラーメッセージ | バリデーションエラー |
| IT-GEN-009 | パラメータなし | （パラメータなし） | HTTP 200 または 400 | デフォルト値使用またはエラー |
| IT-GEN-010 | MIDI生成失敗シミュレート | （mock で失敗） | HTTP 500, エラーメッセージ | "Failed to generate MIDI file" |
| IT-GEN-011 | MP3生成失敗シミュレート | （mock で失敗） | HTTP 500, エラーメッセージ | "Failed to generate MP3 file" |

#### 3.1.3 GET /random.mp3

| テストケースID | テスト項目 | リクエスト | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| IT-MP3-001 | MP3ファイル取得成功 | POST generate_music 後、GET /random.mp3 | HTTP 200, audio/mpeg | MP3バイナリ返却 |
| IT-MP3-002 | MP3ファイルなし | セッションなしで GET /random.mp3 | HTTP 404, エラーメッセージ | "MP3 file not found" |
| IT-MP3-003 | ファイル削除後 | ファイル削除後に GET /random.mp3 | HTTP 404, エラーメッセージ | ファイル再生成されない |

#### 3.1.4 GET /download/midi

| テストケースID | テスト項目 | リクエスト | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| IT-DL-001 | MIDIダウンロード成功 | POST generate_music 後、GET /download/midi | HTTP 200, audio/midi, attachment ヘッダ | MIDIバイナリ返却 |
| IT-DL-002 | MIDIファイルなし | セッションなしで GET /download/midi | HTTP 404, エラーメッセージ | "MIDI file not found" |
| IT-DL-003 | ファイル名検証 | GET /download/midi | Content-Disposition: attachment; filename="music.mid" | ファイル名確認 |

#### 3.1.5 POST /clear_session

| テストケースID | テスト項目 | リクエスト | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| IT-CLR-001 | セッションクリア成功 | POST generate_music 後、POST /clear_session | HTTP 200, message メッセージ | ファイル削除、セッション削除 |
| IT-CLR-002 | クリア後ファイルなし | POST /clear_session 後、GET /random.mp3 | HTTP 404 | ファイル削除確認 |
| IT-CLR-003 | セッションなしでクリア | POST /clear_session（セッションなし） | HTTP 200 | エラーなく成功 |

**テストコード例**:
```python
import pytest
from flask import Flask
from app import app

@pytest.fixture
def client():
    """テストクライアント"""
    app.config['TESTING'] = True
    with app.test_client() as client:
        yield client

def test_generate_music_success(client):
    """音楽生成成功テスト"""
    response = client.post('/generate_music', data={
        'scale': 'major',
        'base_note': 'C'
    })
    
    assert response.status_code == 200
    data = response.get_json()
    assert 'notes' in data
    assert 'wav_file' in data
    assert 'midi_file' in data
    assert isinstance(data['notes'], list)

def test_generate_music_invalid_scale(client):
    """無効なスケール値テスト"""
    response = client.post('/generate_music', data={
        'scale': 'invalid',
        'base_note': 'C'
    })
    
    assert response.status_code == 400
    data = response.get_json()
    assert 'error' in data

def test_download_midi_after_generation(client):
    """生成後のMIDIダウンロードテスト"""
    # 音楽生成
    client.post('/generate_music', data={
        'scale': 'major',
        'base_note': 'C'
    })
    
    # ダウンロード
    response = client.get('/download/midi')
    assert response.status_code == 200
    assert response.content_type == 'audio/midi'
```

---

### 3.2 セッション管理テスト

| テストケースID | テスト項目 | テスト内容 | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| IT-SESSION-001 | セッション作成 | 初回リクエスト後、セッションID確認 | セッションが作成される | Cookie に session ID 含まれる |
| IT-SESSION-002 | ファイルパス保存 | generate_music 後、セッションデータ確認 | midi_file, mp3_file が保存 | セッション内容確認 |
| IT-SESSION-003 | セッション分離 | 別のクライアントでリクエスト | セッションが分離される | クライアント間で干渉なし |
| IT-SESSION-004 | セッション有効期限 | 1時間経過シミュレート | セッション削除 | mock time.time() で検証 |
| IT-SESSION-005 | 新生成時の古いファイル削除 | 連続で2回生成 | 最初のファイルが削除 | セッション内のファイルが上書き |

---

### 3.3 ファイル管理テスト

| テストケースID | テスト項目 | テスト内容 | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| IT-FILE-001 | ファイル生成位置 | MIDIファイル生成後 | static/ ディレクトリ内に保存 | 指定ディレクトリ確認 |
| IT-FILE-002 | ファイル名一意性 | 複数回生成 | すべてのファイル名が一意 | ランダム文字列検証 |
| IT-FILE-003 | ファイルアクセス権限 | 生成ファイルのアクセス権限確認 | アプリが読書き可能 | os.stat() で権限確認 |
| IT-FILE-004 | ファイルサイズ | 生成ファイルのサイズ確認 | MIDI <100KB, MP3 <10MB | ファイルサイズ検証 |
| IT-FILE-005 | パストラバーサル対策 | `/download/midi?path=../../etc/passwd` | HTTP 403 または 404 | is_safe_path() 検証 |

---

## 4. API E2E テスト

### 4.1 完全なワークフロー テスト

**シナリオ**: 音楽生成 → 再生 → ダウンロード → クリア

```
1. POST /generate_music
   ↓ HTTP 200
2. GET /random.mp3（再生ファイル取得）
   ↓ HTTP 200, MP3バイナリ
3. GET /download/midi（ダウンロード）
   ↓ HTTP 200, MIDIバイナリ
4. POST /clear_session
   ↓ HTTP 200
5. GET /random.mp3（クリア後アクセス）
   ↓ HTTP 404
```

| テストケースID | テスト項目 | 期待結果 | 備考 |
|--------|---------|--------|------|
| IT-E2E-001 | 全フロー実行 | 各ステップで期待されるステータスコード返却 | エラーなく完了 |
| IT-E2E-002 | クリア検証 | クリア後のファイルアクセス失敗 | ファイル削除確認 |

---

## 5. セキュリティテスト

### 5.1 バリデーション テスト

| テストケースID | テスト項目 | 攻撃パターン | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| SEC-VAL-001 | SQLインジェクション | `scale="major'; DROP TABLE--"` | エラーハンドリング | ファイルシステムのみなので非該当 |
| SEC-VAL-002 | XSS攻撃 | `base_note="<script>alert(1)</script>"` | 入力検証でエラー | base_note は12音階のみ有効 |
| SEC-VAL-003 | パストラバーサル | `/download/midi?path=../../etc/passwd` | HTTP 403/404 | is_safe_path() 検証 |
| SEC-VAL-004 | NULL バイト | `scale="major%00"` | 入力検証でエラー | バリデーション通過不可 |

### 5.2 CORS テスト

| テストケースID | テスト項目 | リクエスト | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| SEC-CORS-001 | 開発環境CORS | Origin: http://localhost:3000 | CORS ヘッダ許可 | すべてのオリジン許可 |
| SEC-CORS-002 | 本番環境CORS | Origin: https://example.com | CORS ヘッダ許可/拒否（設定依存） | 指定オリジンのみ許可 |
| SEC-CORS-003 | 無効なオリジン | Origin: https://evil.com | CORS ヘッダなし | 指定外オリジン拒否 |

### 5.3 ファイルセキュリティ テスト

| テストケースID | テスト項目 | テスト内容 | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| SEC-FILE-001 | ファイル権限 | アプリ以外のプロセスからアクセス | ファイル読書き制限（OS依存） | OS レベルの権限確認 |
| SEC-FILE-002 | ディスク容量チェック | static/ がいっぱい | エラーハンドリング、ユーザーに通知 | OSError ハンドリング |
| SEC-FILE-003 | ファイル削除タイムライン | クリア後の確実な削除 | ファイルが即座に削除 | 復旧不可確認 |

---

## 6. パフォーマンステスト

### 6.1 応答時間テスト

| テストケースID | テスト項目 | 対象 | 許容時間 | 備考 |
|--------|---------|------|--------|------|
| PERF-TIME-001 | MIDI生成時間 | generate_random_midi（20音符） | <50ms | CPU集約的 |
| PERF-TIME-002 | MP3変換時間 | generate_mp3（20音符） | <10秒 | Timidity+pydub |
| PERF-TIME-003 | MIDI解析時間 | parse_midi（20音符） | <10ms | CPU集約的 |
| PERF-TIME-004 | エンドポイント完全処理 | POST /generate_music 完全完了 | <15秒 | 全処理時間 |
| PERF-TIME-005 | ダウンロード時間 | GET /download/midi | <500ms | ファイル送信 |

### 6.2 メモリ使用量テスト

| テストケースID | テスト項目 | テスト内容 | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| PERF-MEM-001 | 単一生成時 | 1回の generate_music | <50MB | プロセスメモリ |
| PERF-MEM-002 | 10回連続生成 | 10回の generate_music | <200MB | メモリリーク検出 |
| PERF-MEM-003 | 並行10リクエスト | 10スレッド同時実行 | <500MB | スレッド安全性 |
| PERF-MEM-004 | セッション保存 | セッションデータサイズ | <1KB/セッション | セッション効率 |

### 6.3 ディスク使用量テスト

| テストケースID | テスト項目 | テスト内容 | 期待結果 | 備考 |
|--------|---------|---------|--------|------|
| PERF-DISK-001 | MIDI ファイルサイズ | 20音符MIDI | <100KB | ファイル効率 |
| PERF-DISK-002 | MP3 ファイルサイズ | 20音符MP3 | <5MB | 圧縮率確認 |
| PERF-DISK-003 | 24時間連続使用 | 1時間に10回生成×24 | <1GB 消費 | ディスク使用量推定 |

---

## 7. テスト実行方法

### 7.1 テスト実行コマンド

```bash
# 全テスト実行
pytest

# ユニットテストのみ
pytest tests/unit/

# 統合テストのみ
pytest tests/integration/

# 特定のテストケース実行
pytest tests/unit/test_midi_generation.py::test_generate_random_midi_major

# カバレッジ測定
pytest --cov=app --cov-report=html

# テスト結果レポート
pytest --html=report.html --self-contained-html
```

### 7.2 ディレクトリ構成

```
random_midi_gen/
├── app.py
├── requirements-dev.txt
├── tests/
│   ├── __init__.py
│   ├── conftest.py              # pytest 設定・共通フィクスチャ
│   ├── unit/
│   │   ├── test_midi_generation.py      # 2.1
│   │   ├── test_mp3_conversion.py       # 2.2
│   │   ├── test_midi_parsing.py         # 2.3
│   │   ├── test_note_conversion.py      # 2.4
│   │   └── test_duration_conversion.py  # 2.5
│   ├── integration/
│   │   ├── test_endpoints.py            # 3.1
│   │   ├── test_session_management.py   # 3.2
│   │   └── test_file_management.py      # 3.3
│   ├── e2e/
│   │   └── test_workflow.py             # 4.1
│   └── security/
│       └── test_security.py             # 5.1-5.3
```

### 7.3 CI/CD 統合

**GitHub Actions ワークフロー** (`.github/workflows/test.yml`):
```yaml
name: Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    python-version: [3.10]
    
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: 3.10
      
      - name: Install dependencies
        run: |
          pip install -r requirements-dev.txt
      
      - name: Run tests
        run: |
          pytest --cov=app --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v2
```

---

## 8. テストカバレッジ目標

| 対象 | 目標 | 備考 |
|------|------|------|
| **ユニットテスト** | 80%以上 | 重要な関数をカバー |
| **統合テスト** | 70%以上 | エンドポイント・セッション・ファイル |
| **全体** | 75%以上 | 本番環境リリース条件 |

### 8.1 カバレッジ測定コマンド

```bash
# カバレッジレポート生成
pytest --cov=app --cov-report=html --cov-report=term-missing

# レポート確認
open htmlcov/index.html  # macOS
# または
start htmlcov/index.html  # Windows
```

---

## 9. テスト実行スケジュール

| フェーズ | タイミング | 実行テスト | 実行者 |
|---------|-----------|---------|--------|
| **開発フェーズ** | コミット前 | ユニットテスト | 開発者 |
| **プルリクエスト** | PR作成時 | 全テスト | CI/CD |
| **本番デプロイ前** | マージ直前 | 全テスト + セキュリティテスト | CI/CD + QA |
| **本番環境** | 定期実行 | smoke テスト（主要フロー） | 自動化 |

---

**作成日**: 2026年1月11日
**バージョン**: 1.0
**対象アプリケーション**: ランダムMIDI音楽生成アプリケーション
