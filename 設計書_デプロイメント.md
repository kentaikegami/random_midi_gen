# ランダムMIDI音楽生成アプリケーション - デプロイメント仕様書

## 1. Docker構成

### 1.1 Dockerfile
```dockerfile
FROM python:3.10-slim-buster

WORKDIR /app

COPY requirements.txt .
RUN apt-get update && apt-get install -y gcc libasound2-dev

RUN pip install -r requirements.txt

RUN apt-get install -y timidity libsndfile1 ffmpeg lame python3-pydub

COPY . .

CMD ["gunicorn", "--workers", "3", "--timeout", "120", "--bind", "0.0.0.0:8000", "app:app"]
```

**ベースイメージ**: `python:3.10-slim-buster`
**作業ディレクトリ**: `/app`

**インストールステップ**:
1. gcc, libasound2-dev（コンパイルツール、ALSA依存）
2. Python依存関係（requirements.txt）
3. 音声処理ツール（timidity, libsndfile1, ffmpeg, lame）
4. アプリケーションコピー
5. Gunicornでサーバー起動

### 1.2 docker-compose.yml
```yaml
version: '3'
services:
  web:
    build: .
    ports:
      - "5001:5001"
    environment:
      - PORT=5001
    volumes:
      - ./static:/app/static
      - ./flask_session:/app/flask_session
```

**サービス名**: web
**ポートマッピング**: `5001:5001`（ホスト:コンテナ）
**ビルド**: Dockerfileを使用
**環境変数**: PORT=5001（コンテナ内ポート）
**ボリューム**:
- `./static:/app/static`: 生成ファイル永続化
- `./flask_session:/app/flask_session`: セッション永続化（オプション）

## 2. サーバー設定

### 2.1 Gunicorn設定
- **ワーカー数**: 3（`--workers 3`）
- **タイムアウト**: 120秒（`--timeout 120`）
- **バインド**: `0.0.0.0:8000`（Dockerfile内）
- **アプリケーション**: `app:app`

**起動コマンド**:
```bash
gunicorn --workers 3 --timeout 120 --bind 0.0.0.0:8000 app:app
```

**ワーカー数の選択基準**:
- 小規模（単一サーバー）: 3-4ワーカー
- 中規模（複数サーバー）: サーバーあたり2-4ワーカー
- CPU集約的タスク: CPU コア数 + 1

### 2.2 環境変数

| 変数名 | 説明 | 必須 | デフォルト値 | 例 |
|--------|------|------|--------|-----|
| `PORT` | アプリケーションのポート番号 | 任意 | 5001 | 5001, 8080 |
| `SECRET_KEY` | セッションキー（本番環境必須） | 本番環境で必須 | `os.urandom(24)` | 生成されたランダムキー |
| `ALLOWED_ORIGINS` | CORS許可オリジン（カンマ区切り） | 任意 | すべてのオリジンを許可 | https://example.com |

### 2.3 環境変数の設定方法

**Docker環境変数ファイル (.env)**:
```bash
PORT=5001
SECRET_KEY=your-secret-key-here
ALLOWED_ORIGINS=https://example.com,https://www.example.com
```

**docker-compose.yml での設定**:
```yaml
environment:
  - PORT=5001
  - SECRET_KEY=${SECRET_KEY}
  - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
```

**本番環境での推奨設定**:
```bash
export SECRET_KEY=$(python3 -c "import os; print(os.urandom(24).hex())")
export ALLOWED_ORIGINS="https://example.com,https://www.example.com"
docker-compose up -d
```

## 3. 依存関係

### 3.1 Pythonパッケージ（requirements.txt）
```
Flask[async]
Flask-Session
mido
Flask-Cors
gunicorn
timidity
pydub
```

**各パッケージの説明**:
| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| Flask[async] | 最新 | Webフレームワーク（非同期対応） |
| Flask-Session | 最新 | セッション管理 |
| mido | 最新 | MIDI処理ライブラリ |
| Flask-Cors | 最新 | CORS設定 |
| gunicorn | 最新 | WSGIサーバー |
| timidity | 最新 | MIDI→WAV変換 |
| pydub | 最新 | 音声ファイル操作（WAV→MP3） |

### 3.2 システムパッケージ（apt-get）

| パッケージ | 用途 | 必須 |
|-----------|------|------|
| **gcc** | C言語コンパイラ（Pythonパッケージビルド用） | 必須 |
| **libasound2-dev** | ALSA音声ライブラリ（Timidity++依存） | 必須 |
| **timidity** | MIDI → WAV変換ツール | 必須 |
| **libsndfile1** | 音声処理ライブラリ（Timidity++依存） | 必須 |
| **ffmpeg** | マルチメディアフレームワーク（pydub使用） | 推奨 |
| **lame** | MP3エンコーダ（pydub使用） | 推奨 |

**インストール順序**:
```dockerfile
# Step 1: ビルドツール
RUN apt-get update && apt-get install -y gcc libasound2-dev

# Step 2: Python依存関係
RUN pip install -r requirements.txt

# Step 3: 音声処理ツール
RUN apt-get install -y timidity libsndfile1 ffmpeg lame python3-pydub
```

### 3.3 外部ツール概要

| ツール | 入力 | 出力 | コマンド例 |
|--------|------|------|-----------|
| **Timidity++** | MIDI ファイル | WAV ファイル | `timidity input.mid -Ow -s 44100 -d 16 -o output.wav` |
| **FFmpeg/lame** | WAV ファイル | MP3 ファイル | pydub が自動選択 |

**Timidity++ コマンドラインオプション**:
```bash
timidity input.mid \
  -Ow        # Wave ファイル出力
  -s 44100   # サンプリングレート (Hz)
  -d 16      # ビット深度
  -o output.wav  # 出力ファイル
```

## 4. デプロイメント手順

### 4.1 ローカル開発環境

**前提条件**:
- Docker, Docker Compose がインストール済み
- ポート 5001 が使用可能

**デプロイ手順**:
```bash
# 1. クローン・作業ディレクトリに移動
cd random_midi_gen

# 2. docker-compose でビルド・起動
docker-compose build
docker-compose up -d

# 3. ブラウザで確認
# http://localhost:5001
```

**ログ確認**:
```bash
docker-compose logs -f web
```

**停止**:
```bash
docker-compose down
```

### 4.2 本番環境デプロイ（AWS EC2 例）

**前提条件**:
- EC2 インスタンス（Ubuntu 20.04 LTS 推奨）
- Docker, Docker Compose インストール済み
- ポート 5001 のセキュリティグループ設定済み

**デプロイ手順**:
```bash
# 1. リポジトリクローン
git clone <repository> /opt/random_midi_gen
cd /opt/random_midi_gen

# 2. 環境変数設定
export SECRET_KEY=$(python3 -c "import os; print(os.urandom(24).hex())")
export ALLOWED_ORIGINS="https://yourdomain.com"

# 3. docker-compose で起動
docker-compose up -d

# 4. ログ確認
docker-compose logs -f web
```

**リバースプロキシ設定（nginx）**:
```nginx
server {
    listen 80;
    server_name yourdomain.com;
    
    location / {
        proxy_pass http://localhost:5001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## 5. ファイル管理

### 5.1 保存ディレクトリ
- **パス**: `static/`
- **自動作成**: アプリケーション起動時に`os.makedirs(UPLOAD_FOLDER, exist_ok=True)`で作成
- **権限**: アプリケーションプロセスが読み書き可能

### 5.2 ファイル命名規則
- **MIDI**: `random_midi_{YYYYMMDD_HHMMSS}_{6文字ランダム}.mid`
- **MP3**: `random_mp3_{YYYYMMDD_HHMMSS}_{6文字ランダム}.mp3`

**例**:
- `random_midi_20260107_143022_a7kQ2m.mid`
- `random_mp3_20260107_143022_a7kQ2m.mp3`

### 5.3 ファイルクリーンアップ
- **新規生成時**: セッション内の古いファイルを削除（`os.remove()`）
- **セッション有効期限切れ**: Flask-Session 自動削除（ファイルは手動削除推奨）
- **セッションクリア時**: `/clear_session` エンドポイントで明示的に削除
- **エラーハンドリング**: `FileNotFoundError` は無視

**定期クリーンアップスクリプト（推奨）**:
```python
import os
import time
from datetime import datetime, timedelta

STATIC_DIR = 'static'
FILE_LIFETIME_HOURS = 24

def cleanup_old_files():
    """24時間以上前のファイルを削除"""
    now = time.time()
    for filename in os.listdir(STATIC_DIR):
        filepath = os.path.join(STATIC_DIR, filename)
        if os.path.isfile(filepath):
            file_age = now - os.path.getmtime(filepath)
            if file_age > FILE_LIFETIME_HOURS * 3600:
                try:
                    os.remove(filepath)
                    print(f"Deleted: {filename}")
                except OSError as e:
                    print(f"Error deleting {filename}: {e}")

if __name__ == '__main__':
    cleanup_old_files()
```

**cron スケジュール設定例**:
```bash
# 毎日深夜 2 時に実行
0 2 * * * cd /opt/random_midi_gen && python3 cleanup_script.py
```

## 6. パフォーマンスチューニング

### 6.1 Gunicorn ワーカー数の調整
```bash
# CPU コア数 * 2 + 1 が目安
# 例：4 コア → 9 ワーカー
gunicorn --workers 9 --timeout 120 --bind 0.0.0.0:8000 app:app
```

### 6.2 タイムアウト設定
```bash
# MP3 変換に時間がかかる場合は増加
gunicorn --workers 3 --timeout 180 --bind 0.0.0.0:8000 app:app
```

### 6.3 メモリ制限（Docker）
```yaml
services:
  web:
    build: .
    ports:
      - "5001:5001"
    mem_limit: 512m
    memswap_limit: 1g
```

## 7. トラブルシューティング

### 7.1 Timidity++ エラー
**エラー**: `Timidity error: ...`

**原因**: Timidity++ が正しくインストールされていない、または不正なMIDIファイル

**解決方法**:
```bash
# Docker 内で確認
docker-compose exec web timidity --version

# 再インストール
docker-compose rebuild web
```

### 7.2 MP3 エンコードエラー
**エラー**: `pydub error: ...`

**原因**: FFmpeg/lame がインストールされていない

**解決方法**:
```bash
# Docker 内で確認
docker-compose exec web ffmpeg -version
docker-compose exec web lame --version

# Dockerfile 内で install を確認
```

### 7.3 ポート競合
**エラー**: `bind: address already in use`

**解決方法**:
```bash
# ポート確認
lsof -i :5001

# 別のポートで起動
docker-compose down
# docker-compose.yml の ports を変更
docker-compose up -d
```

### 7.4 ログ確認
**Dockerコンテナ内のログを確認**:
```bash
# リアルタイムログ表示
docker-compose logs -f web

# 直近のログを表示
docker-compose logs web --tail 50
```

**ログレベル**:
- **INFO**: 正常な処理フロー（エンドポイント呼び出し、ファイル生成成功等）
- **WARNING**: 予期しない入力値（バリデーションエラー、ファイル削除失敗等）
- **ERROR**: 処理エラー（MP3変換失敗、MIDI解析エラー等）
- **DEBUG**: 詳細情報（絶対パス、オブジェクト情報等）

## 8. セキュリティ チェックリスト

- [ ] SECRET_KEY を環境変数で設定（本番環境）
- [ ] ALLOWED_ORIGINS を指定したオリジンに制限（本番環境）
- [ ] HTTPS を有効化（リバースプロキシで設定）
- [ ] 定期的なファイルクリーンアップを実行
- [ ] セッション有効期限を適切に設定
- [ ] ログを監視して異常を検出
- [ ] Gunicorn のワーカーに適切なメモリ制限を設定
- [ ] パストラバーサル対策（is_safe_path()で検証）
- [ ] ファイル削除権限チェック（safe_remove_file()で実施）
- [ ] 入力値バリデーション（scale, base_note）
